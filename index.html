<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Deutsch mit Said ‚Äì Vokabelblatt Pro</title>

  <!-- ‚úÖ jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- ‚úÖ html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- ‚úÖ Arabic font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --carbon:#0B0D0E; --carbon2:#0F1412;
      --ink:#EAF2EE; --muted:#A7B6AE;
      --moss:#2E5E3A; --moss2:#3E7A4B;
      --brg:#004225; --brg2:#0B5A36;
      --shadow: 0 16px 60px rgba(0,0,0,0.45);
      --glass1: rgba(255,255,255,0.10); --glass2: rgba(255,255,255,0.06);
      --wa:#25D366; --waDark:#0b5a46;
      --box-h: 260px; 
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; width: 100%; margin: 0; padding: 0; }
    body{
      font-family: Arial, sans-serif; color:var(--ink);
      background: linear-gradient(180deg, var(--carbon), var(--carbon2));
      overflow-x:hidden; -webkit-text-size-adjust: 100%;
    }

    /* aura effect */
    body::before{
      content:""; position: fixed; inset: -35%; z-index: -2; pointer-events:none;
      background:
        radial-gradient(60% 50% at 12% 22%, rgba(46,94,58,0.55), transparent 62%),
        radial-gradient(55% 50% at 88% 28%, rgba(0,66,37,0.48), transparent 62%),
        radial-gradient(50% 45% at 55% 85%, rgba(62,122,75,0.38), transparent 62%);
      filter: blur(26px) saturate(1.15); animation: auraDrift 18s ease-in-out infinite alternate; opacity: .92;
    }
    @keyframes auraDrift{ 0% { transform: translate3d(-2%, -1%, 0) scale(1.02); } 100% { transform: translate3d(-1%,  3%, 0) scale(1.03); } }
    @media (prefers-reduced-motion: reduce){ body::before{ animation:none; } }

    /* ===== APP WRAPPER ===== */
    #app{ max-width: var(--app-max-w, 1100px); margin: 0 auto; padding: 16px; display: flex; flex-direction: column; gap: 16px; min-height: 100vh; }

    /* ---------- HEADER ---------- */
    .topbar{
      position: relative; z-index: 5; display:flex; align-items:center; justify-content:space-between; gap:16px; padding:16px;
      border-radius: 18px; background: linear-gradient(180deg, var(--glass1), var(--glass2));
      border: 1px solid rgba(255,255,255,0.12); backdrop-filter: blur(12px); box-shadow: var(--shadow); flex-wrap: wrap; 
    }
    .brand{ display:flex; flex-direction:column; gap:3px; flex: 1 1 200px; }
    .brandTitle{ font-size: clamp(18px, 4vw, 22px); font-weight: 900; line-height:1.1; background: linear-gradient(90deg, #d7f7e6, rgba(62,122,75,0.95), rgba(0,66,37,0.95)); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .brandSub{ font-size: 13px; color: var(--muted); font-weight: 800; }

    .topActions{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; flex: 1 1 300px; }
    .pill{ display:flex; align-items:center; gap:10px; padding:10px; border-radius: 999px; background: rgba(0,0,0,0.16); border: 1px solid rgba(255,255,255,0.12); flex-wrap: wrap; width: 100%; }
    .pill input{ padding:10px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.14); outline:none; background: rgba(0,0,0,0.24); color: var(--ink); font-size: 14px; font-weight: 800; flex: 1 1 120px; min-width: 80px; }
    .pill input:focus{ border-color: rgba(62,122,75,0.70); box-shadow: 0 0 0 4px rgba(62,122,75,0.18); }

    .btn{ border: none; cursor: pointer; padding:10px 14px; border-radius: 999px; font-weight: 900; transition: all .15s ease; display:flex; align-items:center; justify-content:center; gap:8px; white-space:nowrap; color: var(--ink); font-size: 14px; }
    .btn:hover{ transform: translateY(-2px); opacity:.98; }
    .btn:active{ transform: translateY(0px) scale(0.97); }
    .btnPrimary{ background: linear-gradient(90deg, var(--brg), var(--moss2)); color:#EAF2EE; box-shadow: 0 8px 20px rgba(0,66,37,0.35); }
    .btnDanger{ background: linear-gradient(90deg, #7a1b1b, #b45309); color:#fff; box-shadow: 0 8px 20px rgba(0,0,0,0.35); }
    .btnLang{ background: linear-gradient(90deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06)); border: 1px solid rgba(255,255,255,0.12); }

    /* ---------- CONTROLS ---------- */
    #controls{ display:flex; flex-wrap:wrap; gap:12px; padding:16px; border-radius: 18px; justify-content:center; align-items: center; background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)); border: 1px solid rgba(255,255,255,0.10); backdrop-filter: blur(12px); box-shadow: var(--shadow); width: 100%; position: relative; z-index: 5; }
    .control-group{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:center; }
    .control-group label{ font-weight: 900; font-size: 14px; color: rgba(234,242,238,0.92); }
    select, input[type="range"]{ padding:10px; border:1px solid rgba(255,255,255,0.14); border-radius: 12px; background: rgba(0,0,0,0.20); color: var(--ink); font-weight: 900; outline: none; }

    #debug{ text-align:center; font-size: 14px; color: rgba(234,242,238,0.82); font-weight: 900; margin: 0; }
    .error{ display:none; text-align:center; color:#ffb4b4; font-weight:900; padding: 10px; background: rgba(255,0,0,0.1); border-radius: 10px; }

    /* ---------- GRID ---------- */
    #grid{ display:grid; gap: 16px; width: 100%; background: transparent; }
    .box{ width: 100%; height: var(--box-h); border-radius: 16px; position:relative; overflow:hidden; border: 1px solid rgba(255,255,255,0.12); background: radial-gradient(circle at 10% 0%, rgba(62,122,75,0.15), transparent 60%), linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); box-shadow: 0 12px 30px rgba(0,0,0,0.4); contain: content; touch-action: pan-y; }
    .flip-card{ width:100%; height:100%; position:relative; transform-style:preserve-3d; transition: transform .6s cubic-bezier(0.4, 0.2, 0.2, 1); }
    .flip-card.flipped{ transform: rotateY(180deg); }
    .flip-side{ position:absolute; inset:0; backface-visibility:hidden; display:flex; flex-direction:column; padding:14px; gap:8px; }
    .flip-back{ transform: rotateY(180deg); direction: rtl; text-align:right; }

    textarea, input { font-size: 16px !important; }

    /* FRONT SIDE */
    .frontWordWrap{ flex: 1; display:flex; align-items:center; justify-content:center; min-height: 45%; }
    .wordInput{ width:100%; border:none; outline:none; resize:none; background:transparent; color: var(--ink); font-weight: 900; text-align:center; overflow:hidden; text-shadow: 0 0 15px rgba(46,94,58,0.3); }
    .exampleWrap{ border-top: 1px solid rgba(255,255,255,0.10); padding-top: 8px; flex: 1.2; display:flex; flex-direction:column; gap:6px; }
    .exampleHeader{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .exampleLabel{ font-size:12px; color: rgba(234,242,238,0.65); font-weight:900; direction:ltr; }
    .autoBtn{ border:none; cursor:pointer; padding:6px 10px; border-radius: 999px; font-weight: 900; font-size: 11px; color: #e9fff4; background: linear-gradient(90deg, rgba(0,66,37,0.92), rgba(62,122,75,0.92)); border: 1px solid rgba(255,255,255,0.12); box-shadow: 0 6px 15px rgba(0,0,0,0.3); }
    .autoBtn:active{ transform: scale(0.95); }
    .autoMsg{ font-size: 11px; font-weight: 900; color: rgba(234,242,238,0.62); min-height: 14px; direction:ltr; text-align:left; }
    .explainInput{ border:none; outline:none; resize:none; background:transparent; color: rgba(234,242,238,0.92); line-height:1.4; flex:1; }

    /* BACK SIDE */
    .posBadge{ display:inline-flex; align-self:flex-start; padding:4px 10px; border-radius:999px; font-size: 11px; font-weight: 900; background: rgba(62,122,75,0.2); border: 1px solid rgba(62,122,75,0.3); color: #d7f7e6; direction:ltr; cursor:pointer; }
    .backTopRow{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-top: 8px; flex: 1; }
    .arabicCenter{ flex: 1.2; text-align:right; font-weight: 700; line-height: 1.6; direction: rtl; color: #e9fff4; font-family: "Amiri", Arial, sans-serif; border: none; outline: none; resize: none; background: transparent; overflow: hidden; }
    .darijaSide{ flex: 1; text-align:right; font-weight: 700; line-height: 1.6; direction: rtl; color: rgba(234,242,238,0.85); border: none; outline: none; resize: none; background: transparent; overflow: hidden; }
    .backNoteWrap{ margin-top: 4px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.10); display:flex; flex-direction:column; gap:6px; flex: 1.2; min-height: 0; }
    .noteLabel{ font-size: 12px; font-weight: 800; opacity: .90; direction: rtl; text-align: right; color: rgba(234,242,238,0.90); }
    .noteInput{ border:none; outline:none; resize:none; background:transparent; color: rgba(234,242,238,0.92); line-height: 1.5; min-height: 30px; text-align:right; direction: rtl; overflow:hidden; font-family: "Amiri", Arial, sans-serif; }

    /* WhatsApp */
    #waBtn{ position: fixed; right: 18px; bottom: 18px; width: 54px; height: 54px; border-radius: 999px; background: var(--wa); border: none; cursor: pointer; box-shadow: 0 16px 30px rgba(0,0,0,0.35); display:flex; align-items:center; justify-content:center; z-index: 9999; }
    #waBtn svg{ width: 28px; height: 28px; fill: #fff; }
    #waPopup{ position: fixed; right: 18px; bottom: 86px; width: 320px; max-width: calc(100vw - 36px); border-radius: 16px; overflow:hidden; box-shadow: 0 18px 50px rgba(0,0,0,0.4); background:#fff; z-index: 9999; display:none; }
    #waPopup.open{ display:block; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popUp { from { transform: scale(0.8) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
    .waHeader{ background: var(--waDark); padding: 14px; display:flex; gap:12px; align-items:center; color:#fff; }
    .waAvatar{ width: 44px; height: 44px; border-radius: 999px; object-fit: cover; border: 2px solid rgba(255,255,255,0.3); background:#0f172a; }
    .waTitle{ font-weight: 900; font-size: 15px; }
    .waSub{ font-size: 12px; opacity: .9; }
    .waClose{ margin-left:auto; border:none; background: rgba(255,255,255,0.15); color:#fff; width: 30px; height: 30px; border-radius: 10px; cursor:pointer; font-weight: bold; }
    .waBody{ padding: 16px; background: #f0f2f5; }
    .waBubble{ background:#fff; border-radius: 12px 12px 12px 2px; padding: 12px; border: 1px solid rgba(0,0,0,0.05); font-weight: 800; color:#111; font-size: 14px; }
    .waBubble small{ display:block; margin-top:6px; color:#666; }
    .waInputWrap{ margin-top: 14px; display:flex; gap:8px; }
    #waInput{ flex:1; border-radius: 20px; border: 1px solid #ccc; padding: 12px 16px; outline:none; font-weight: 800; font-size: 15px;}
    #waSend{ border:none; border-radius: 20px; padding: 0 20px; background: var(--wa); color:#fff; font-weight: 900; cursor:pointer; }

    /* =========================================================
       ‚úÖ PDF STAGE - PERFECT ALIGNMENT (MIRROR EFFECT ADDED)
       ========================================================= */
    #pdfStage{
      position: fixed; left: -99999px; top: -99999px;
      width: 210mm; height: 297mm; /* ŸÇŸäÿßÿ≥ ÿßŸÑŸàÿ±ŸÇÿ© A4 ÿ®ÿßŸÑÿ∂ÿ®ÿ∑ */
      padding: 12mm; /* ŸáŸàÿßŸÖÿ¥ ŸÖÿ™ÿ≥ÿßŸàŸäÿ© ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ¨Ÿáÿßÿ™ */
      background: #ffffff; color: #111; box-sizing: border-box; font-family: Arial, sans-serif;
      display: flex; flex-direction: column; z-index: -999;
    }
    
    .pdfHeaderArea { height: var(--header-h); width: 100%; margin-bottom: 4mm; }
    .pdfBigTitle{ margin:0; text-align:center; font-weight: 900; font-size: 18px; color:#0B5A36; line-height: 1.2; }
    .pdfMeta{ display:flex; justify-content:space-between; gap: 6mm; font-size: 11px; font-weight: 900; margin-top: 5mm; }
    .pdfMeta span{ border: 1px solid rgba(0,0,0,0.14); border-radius: 999px; padding: 2.5mm 4mm; background: rgba(0,0,0,0.02); }
    
    .pdfGrid{
      display: grid; 
      gap: var(--pdfGap); 
      grid-template-columns: repeat(var(--pdfCols), var(--pdfBoxW));
      grid-auto-rows: var(--pdfBoxH); /* ÿ∑Ÿàÿ® ÿßŸÑŸÖÿ±ÿ®ÿπÿßÿ™ ÿ´ÿßÿ®ÿ™ */
      width: 100%;
    }
    
    .pdfCard{
      width: var(--pdfBoxW); height: var(--pdfBoxH);
      background: #fff; border: 1px solid rgba(0,0,0,0.25); border-radius: 14px; overflow: hidden;
    }
    /* ÿ®ÿ∑ÿßŸÇÿ© ŸàŸáŸÖŸäÿ© ŸÑŸÑŸÖÿ≠ÿßŸÅÿ∏ÿ© ÿπŸÑŸâ ÿßŸÑÿ™Ÿàÿßÿ≤ŸÜ ŸÅŸä ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÖÿ≤ÿØŸàÿ¨ÿ© */
    .pdfCard.empty { border: none; background: transparent; }

    .pdfCardInner{ padding: 12px; height: 100%; box-sizing: border-box; display: flex; flex-direction: column; gap: 8px; }
    .pdfWordWrap{ flex: 1; display:flex; align-items:center; justify-content:center; text-align:center; }
    .pdfWord{ font-weight: 900; font-size: 18px; white-space: pre-wrap; word-break: break-word; color: #000; }
    .pdfLine{ height: 1px; background: rgba(0,0,0,0.15); width: 100%; }
    .pdfExample{ font-size: 12px; line-height: 1.4; flex: 1; color: #222; }
    .pdfAr{ direction: rtl; text-align: center; font-family: "Amiri", Arial, sans-serif; font-weight: 700; font-size: 18px; line-height: 1.5; color: #000; }
    .pdfDar{ direction: rtl; text-align: right; font-weight: 700; font-size: 13px; line-height: 1.5; color: #333; }
    .pdfNote{ direction: rtl; text-align: right; font-size: 12px; line-height: 1.4; font-family: "Amiri", Arial, sans-serif; color: #444; }

    /* Loading Overlay */
    #pdfLoading { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 99999; display: none; align-items: center; justify-content: center; flex-direction: column; color: white; font-weight: 900; font-size: 20px; backdrop-filter: blur(5px); }
    .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #25D366; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿØŸäÿßŸÑ ÿßŸÑŸÄ PDF -->
  <div id="pdfLoading">
    <div class="spinner"></div>
    <div id="loadingText">PDF wird erstellt... Bitte warten.</div>
  </div>

  <div id="app">
    <!-- ‚úÖ HEADER -->
    <div class="topbar" id="topbar">
      <div class="brand">
        <div class="brandTitle">Deutsch mit Said</div>
        <div class="brandSub" data-i18n="subtitle">ist einfacher: w√§hlen ‚Ä¢ schreiben ‚Ä¢ drucken</div>
      </div>
      <div class="topActions">
        <div class="pill">
          <input type="text" id="name" placeholder="Name">
          <input type="date" id="date">
          <input type="text" id="topic" placeholder="Thema">
        </div>
        <button class="btn btnLang" id="langBtn" type="button">DE / EN</button>
      </div>
    </div>

    <!-- ‚úÖ CONTROLS -->
    <div id="controls">
      <div class="control-group">
        <label data-i18n="count">Anzahl</label>
        <input type="range" id="numBoxes" min="1" max="200" value="12" step="1" style="max-width: 100px;">
        <span id="numBoxesValue" style="font-weight:900; width: 24px; color:white;">12</span>
      </div>
      <div class="control-group">
        <label data-i18n="cols">Spalten</label>
        <select id="columns">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3" selected>3</option>
          <option value="4">4</option>
        </select>
      </div>
      <div class="control-group">
        <label data-i18n="size">Gr√∂√üe</label>
        <select id="boxSize">
          <option value="small" data-i18n="small">Klein</option>
          <option value="normal" selected data-i18n="normal">Normal</option>
          <option value="large" data-i18n="large">Gro√ü</option>
        </select>
      </div>
      <div class="control-group" style="margin: 0 10px;">
        <label style="cursor:pointer; display:flex; align-items:center; gap:5px;">
          <input type="checkbox" id="showBack" style="width:18px; height:18px;"> 
          <span data-i18n="back">R√ºckseite zeigen</span>
        </label>
      </div>
      <button class="btn btnDanger" id="resetBtn" type="button" data-i18n="reset">Leeren</button>
      <button class="btn btnPrimary" id="downloadPdfBtn" type="button">PDF</button>
    </div>

    <div id="debug">Viel Erfolg</div>
    <div id="errorMsg" class="error"></div>
    
    <!-- ‚úÖ GRID -->
    <div id="grid"></div>
    
    <!-- ‚úÖ Social Footer -->
    <div class="said-social">
      <a href="https://www.instagram.com/saidaiadi" target="_blank" aria-label="Instagram">
        <svg viewBox="0 0 24 24"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm10 2H7a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3zm-5 4a6 6 0 1 1 0 12 6 6 0 0 1 0-12zm0 2a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm6.2-.9a1.1 1.1 0 1 1-2.2 0 1.1 1.1 0 0 1 2.2 0z"/></svg>
      </a>
      <a href="https://www.tiktok.com/@saidaiadii" target="_blank" aria-label="TikTok">
        <svg viewBox="0 0 24 24"><path d="M16.5 3c.6 2.6 2.2 4.2 4.8 4.6v3.1c-1.7 0-3.3-.5-4.8-1.4v6.3c0 3.6-2.9 6.4-6.4 6.4S3.7 19.2 3.7 15.6s2.9-6.4 6.4-6.4c.5 0 1 .1 1.5.2v3.4c-.5-.3-1-.4-1.5-.4-1.8 0-3.2 1.4-3.2 3.2S8.3 18.8 10.1 18.8s3.2-1.4 3.2-3.2V3h3.2z"/></svg>
      </a>
    </div>
  </div>

  <!-- PDF Hidden Stage -->
  <div id="pdfStage" aria-hidden="true"></div>

  <button id="waBtn" aria-label="WhatsApp">
    <svg viewBox="0 0 32 32"><path d="M19.11 17.25c-.27-.14-1.6-.79-1.85-.88-.25-.09-.43-.14-.62.14-.18.27-.71.88-.87 1.06-.16.18-.32.21-.59.07-.27-.14-1.16-.43-2.21-1.36-.82-.73-1.38-1.63-1.54-1.9-.16-.27-.02-.42.12-.56.12-.12.27-.32.41-.48.14-.16.18-.27.27-.46.09-.18.05-.34-.02-.48-.07-.14-.62-1.5-.85-2.06-.22-.53-.45-.46-.62-.47h-.53c-.18 0-.48.07-.73.34-.25.27-.96.94-.96 2.29 0 1.35.99 2.65 1.13 2.83.14.18 1.95 2.97 4.73 4.17.66.29 1.18.46 1.58.59.66.21 1.26.18 1.74.11.53-.08 1.6-.65 1.83-1.27.23-.62.23-1.15.16-1.27-.07-.12-.25-.18-.52-.32zM16 3C9.38 3 4 8.38 4 15c0 2.11.55 4.17 1.6 5.99L4 29l8.21-1.56A11.92 11.92 0 0 0 16 27c6.62 0 12-5.38 12-12S22.62 3 16 3zm0 21.7c-1.94 0-3.83-.52-5.47-1.5l-.39-.23-4.87.93.93-4.74-.25-.41A9.69 9.69 0 0 1 6.3 15C6.3 9.64 10.64 5.3 16 5.3S25.7 9.64 25.7 15 21.36 24.7 16 24.7z"/></svg>
  </button>

  <div id="waPopup">
    <div class="waHeader">
      <img class="waAvatar" id="waAvatar" src="said.jpg" alt="Said">
      <div><div class="waTitle">Said Lehrer</div><div class="waSub">Deutsch-Fragen? Schreib mir.</div></div>
      <button class="waClose" id="waClose">√ó</button>
    </div>
    <div class="waBody">
      <div class="waBubble">Hi! üëã<br>Schick mir deine Frage zu Deutsch.<br><small>ŸÖÿß ÿ™ÿ™ÿ±ÿØÿØÿ¥: ÿ≥ŸàŸÑŸÜŸä Ÿàÿ£ŸÜÿß ŸÜÿ¨ÿßŸàÿ®ŸÉ üòä</small></div>
      <div class="waInputWrap"><input id="waInput" type="text" placeholder="Deine Frage..."><button id="waSend">Send</button></div>
    </div>
  </div>

  <style>
    .said-social{ display:flex; justify-content:center; gap:18px; padding:20px 0 40px; }
    .said-social a{ width:50px; height:50px; display:flex; align-items:center; justify-content:center; border-radius:14px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); transition:0.3s ease; }
    .said-social a:hover{ transform:translateY(-4px); border-color:var(--wa); box-shadow:0 0 15px rgba(37,211,102,0.3); background:rgba(255,255,255,0.1); }
    .said-social svg{ width:24px; height:24px; fill:white; transition:0.3s; }
  </style>

  <script>
    // ========= ÿßŸÑÿ≠ŸÖÿßŸäÿ© =========
    (function(){
      document.addEventListener('contextmenu', e => e.preventDefault());
      document.addEventListener('dragstart', e => e.preventDefault());
      document.addEventListener('keydown', (e) => {
        const k = (e.key || '').toLowerCase();
        if ((e.ctrlKey || e.metaKey) && ['s','u','p','c','x','a'].includes(k)) e.preventDefault();
      });
      const css = document.createElement('style');
      css.textContent = `.box::after{content:"";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:14px;color:rgba(255,255,255,0.04);transform:rotate(-22deg);pointer-events:none;letter-spacing:.6px;}`;
      document.head.appendChild(css);
    })();

    // ========= ÿßŸÑŸÑÿ∫ÿ© =========
    let lang = 'de';
    const I18N = {
      de: { subtitle:"ist einfacher: w√§hlen ‚Ä¢ schreiben ‚Ä¢ drucken", count:"Anzahl", cols:"Spalten", size:"Gr√∂√üe", small:"Klein", normal:"Normal", large:"Gro√ü", back:"R√ºckseite zeigen", reset:"Leeren" },
      en: { subtitle:"made easy: choose ‚Ä¢ write ‚Ä¢ print", count:"Count", cols:"Cols", size:"Size", small:"Small", normal:"Normal", large:"Large", back:"Show Back", reset:"Clear" }
    };
    const langBtn = document.getElementById('langBtn');
    function applyI18n(){
      langBtn.textContent = (lang === 'de') ? 'DE / EN' : 'EN / DE';
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if (I18N[lang] && I18N[lang][key]) el.textContent = I18N[lang][key];
      });
      document.querySelector('option[value="small"]').textContent  = I18N[lang].small;
      document.querySelector('option[value="normal"]').textContent = I18N[lang].normal;
      document.querySelector('option[value="large"]').textContent  = I18N[lang].large;
    }

    // ========= ÿßŸÑŸÇÿßŸÖŸàÿ≥ =========
    const RAW_ENTRIES = [
      { word:"Verkehrszeichen", pos:"N", ar:"ÿπŸÑÿßŸÖÿ© ŸÖÿ±Ÿàÿ±", darija:"ÿ®ŸÑÿßŸÉÿ© ÿØŸäÿßŸÑ ÿßŸÑÿ∑ÿ±ŸäŸÇ", de_example:"Das Verkehrszeichen ist wichtig.", darija_example:"ÿ®ŸÑÿßŸÉÿ© ÿßŸÑÿ∑ÿ±ŸäŸÇ ŸÖŸáŸÖÿ©." },
      { word:"Vorfahrt", pos:"N", ar:"ÿ£ŸàŸÑŸàŸäÿ© ŸÖÿ±Ÿàÿ±", darija:"ÿ≠ŸÇ ÿßŸÑŸÖÿ±Ÿàÿ±", de_example:"Er hat Vorfahrt.", darija_example:"ÿπŸÜÿØŸà ÿ≠ŸÇ ÿßŸÑŸÖÿ±Ÿàÿ±." },
      { word:"Kreuzung", pos:"N", ar:"ÿ™ŸÇÿßÿ∑ÿπ ÿ∑ÿ±ŸÇ", darija:"ÿßŸÑŸÉÿ±Ÿàÿßÿ≤Ÿä", de_example:"An der Kreuzung ist eine Ampel.", darija_example:"ŸÅÿßŸÑŸÉÿ±Ÿàÿßÿ≤Ÿä ŸÉÿßŸäŸÜ ÿßŸÑÿ≥ŸäŸÜŸäÿßŸÑ." },
      { word:"Kurve", pos:"N", ar:"ŸÖŸÜÿπÿ∑ŸÅ ÿ∑ÿ±ŸäŸÇ", darija:"ÿßŸÑŸÅŸäÿ±ÿßÿ¨", de_example:"Die Kurve ist gef√§hrlich.", darija_example:"ÿßŸÑŸÅŸäÿ±ÿßÿ¨ ÿÆÿ∑Ÿäÿ±." },
      { word:"Leitplanke", pos:"N", ar:"ÿ≠ÿßÿ¨ÿ≤ ÿ¨ÿßŸÜÿ®Ÿä", darija:"ÿßŸÑÿ≠ÿØŸäÿØÿ© ŸÅÿßŸÑÿ∑ÿ±ŸäŸÇ", de_example:"Das Auto f√§hrt gegen die Leitplanke.", darija_example:"ÿßŸÑÿ∑ŸàŸÖŸàÿ®ŸäŸÑ ÿ∂ÿ±ÿ®ÿßÿ™ ŸÅÿßŸÑÿ≠ÿØŸäÿØÿ© ÿØŸäÿßŸÑ ÿßŸÑÿ∑ÿ±ŸäŸÇ." },
      { word:"Landstra√üe", pos:"N", ar:"ÿ∑ÿ±ŸäŸÇ ÿ±ŸäŸÅŸä", darija:"ÿ∑ÿ±ŸäŸÇ ÿÆÿßÿ±ÿ¨ ÿßŸÑŸÖÿØŸäŸÜÿ©", de_example:"Wir fahren auf der Landstra√üe.", darija_example:"ŸÉŸÜÿ≥ŸàŸÇŸà ŸÅÿ∑ÿ±ŸäŸÇ ÿÆÿßÿ±ÿ¨ ÿßŸÑŸÖÿØŸäŸÜÿ©." },
      { word:"Mitfahrgelegenheit", pos:"N", ar:"ŸÅÿ±ÿµÿ© ÿ±ŸÉŸàÿ®", darija:"ÿ™ŸàÿµŸäŸÑÿ© ŸÖÿπ ÿ¥Ÿä ÿ≠ÿØ", de_example:"Ich suche eine Mitfahrgelegenheit.", darija_example:"ŸÉŸÜŸÇŸÑÿ® ÿπŸÑŸâ ÿ™ŸàÿµŸäŸÑÿ©." },
      { word:"Pendler", pos:"N", ar:"ŸÖÿ≥ÿßŸÅÿ± ŸäŸàŸÖŸä", darija:"ÿßŸÑŸÑŸä ŸÉŸäŸÖÿ¥Ÿä ŸàŸäÿ±ÿ¨ÿπ ŸÑŸÑÿÆÿØŸÖÿ©", de_example:"Der Pendler f√§hrt jeden Tag.", darija_example:"ŸÉŸäŸÖÿ¥Ÿä ŸàŸäÿ±ÿ¨ÿπ ŸÉŸÑ ŸÜŸáÿßÿ±." },
      { word:"Radweg", pos:"N", ar:"ŸÖÿ≥ÿßÿ± ÿØÿ±ÿßÿ¨ÿßÿ™", darija:"ÿ∑ÿ±ŸäŸÇ ÿØŸäÿßŸÑ ÿßŸÑÿ®ŸäŸÉÿßŸÑÿ©", de_example:"Der Radweg ist neu.", darija_example:"ÿ∑ÿ±ŸäŸÇ ÿßŸÑÿ®ŸäŸÉÿßŸÑÿ© ÿ¨ÿØŸäÿØ." },
      { word:"Semesterticket", pos:"N", ar:"ÿ™ÿ∞ŸÉÿ±ÿ© ŸÅÿµŸÑ", darija:"ÿ™ŸäŸÉŸä ÿØŸäÿßŸÑ ÿßŸÑÿ≥ŸÖŸäÿ≥ÿ™ÿ±", de_example:"Ich habe ein Semesterticket.", darija_example:"ÿπŸÜÿØŸä ÿ™ŸäŸÉŸä ÿØŸäÿßŸÑ ÿßŸÑÿ≥ŸÖŸäÿ≥ÿ™ÿ±." },
      { word:"Stau", pos:"N", ar:"ÿßÿ≤ÿØÿ≠ÿßŸÖ ÿ≥Ÿäÿ±", darija:"ÿßŸÑÿ≤ÿ≠ÿßŸÖ", de_example:"Es gibt einen Stau.", darija_example:"ŸÉÿßŸäŸÜ ÿßŸÑÿ≤ÿ≠ÿßŸÖ." },
      { word:"Tempo", pos:"N", ar:"ÿ≥ÿ±ÿπÿ© ŸÖÿ≠ÿØÿØÿ©", darija:"ÿßŸÑÿ≥ÿ±ÿπÿ©", de_example:"Das Tempo ist 50.", darija_example:"ÿßŸÑÿ≥ÿ±ÿπÿ© 50." },
      { word:"Tunnel", pos:"N", ar:"ŸÜŸÅŸÇ ÿ∑ÿ±ŸäŸÇ", darija:"ÿ™ŸàŸÜŸäŸÑ", de_example:"Das Auto f√§hrt durch den Tunnel.", darija_example:"ÿßŸÑÿ∑ŸàŸÖŸàÿ®ŸäŸÑ ÿØÿßÿ≤ÿ™ ŸÖŸÜ ÿßŸÑÿ™ŸàŸÜŸäŸÑ." },
      { word:"√úberholman√∂ver", pos:"N", ar:"ÿπŸÖŸÑŸäÿ© ÿ™ÿ¨ÿßŸàÿ≤", darija:"ÿØŸàÿ≤ÿßŸÜ ÿπŸÑŸâ ÿ¥Ÿä ÿ≠ÿØ", de_example:"Das √úberholman√∂ver ist gef√§hrlich.", darija_example:"ÿØŸàÿ≤ÿßŸÜ ÿπŸÑŸâ ÿ¥Ÿä ÿ≠ÿØ ÿÆÿ∑Ÿäÿ±." },
      { word:"Unfall", pos:"N", ar:"ÿ≠ÿßÿØÿ´ ÿ∑ÿ±ŸäŸÇ", darija:"ÿ≠ÿßÿØÿ´ÿ©", de_example:"Es gibt einen Unfall.", darija_example:"ŸÉÿßŸäŸÜÿ© ÿ≠ÿßÿØÿ´ÿ©." },
      { word:"Verkehr", pos:"N", ar:"ÿ≠ÿ±ŸÉÿ© ŸÖÿ±Ÿàÿ±", darija:"ÿßŸÑÿ≥Ÿäÿ±", de_example:"Der Verkehr ist stark.", darija_example:"ÿßŸÑÿ≥Ÿäÿ± ŸÇŸàŸä." },
      { word:"Verkehrsregel", pos:"N", ar:"ŸÇÿßŸÜŸàŸÜ ŸÖÿ±Ÿàÿ±", darija:"ŸÇÿßŸÜŸàŸÜ ÿßŸÑÿ≥Ÿäÿ±", de_example:"Ich kenne die Verkehrsregeln.", darija_example:"ŸÉŸÜÿπÿ±ŸÅ ŸÇÿßŸÜŸàŸÜ ÿßŸÑÿ≥Ÿäÿ±." },
      { word:"Verkehrsmittel", pos:"N", ar:"Ÿàÿ≥ŸäŸÑÿ© ŸÜŸÇŸÑ", darija:"Ÿàÿ≥ŸäŸÑÿ© ŸÜŸÇŸÑ", de_example:"Das Verkehrsmittel ist schnell.", darija_example:"Ÿàÿ≥ŸäŸÑÿ© ÿßŸÑŸÜŸÇŸÑ ÿ≥ÿ±Ÿäÿπÿ©." },
      
      // ===== Arbeit und Beruf (ÿ¨ÿ®ÿßŸÑ / ÿ≥Ÿäÿßÿ≠ÿ©) =====
      { word:"(Langlauf)Loipe", pos:"N", ar:"ŸÖÿ≥ÿßÿ± ÿ™ÿ≤ŸÑÿ¨", darija:"ÿ∑ÿ±ŸäŸÇ ÿØŸäÿßŸÑ ÿßŸÑÿ≥ŸÉŸä", de_example:"Die Loipe ist lang.", darija_example:"ÿ∑ÿ±ŸäŸÇ ÿßŸÑÿ≥ŸÉŸä ÿ∑ŸàŸäŸÑÿ©." },
      { word:"Loipe", pos:"N", ar:"ŸÖÿ≥ÿßÿ± ÿ™ÿ≤ŸÑÿ¨", darija:"ÿ∑ÿ±ŸäŸÇ ÿØŸäÿßŸÑ ÿßŸÑÿ≥ŸÉŸä", de_example:"Die Loipe ist lang.", darija_example:"ÿ∑ÿ±ŸäŸÇ ÿßŸÑÿ≥ŸÉŸä ÿ∑ŸàŸäŸÑÿ©." }, 
      { word:"Lift", pos:"N", ar:"ŸÖÿµÿπÿØ ÿ¨ÿ®ŸÑŸä", darija:"ÿ™ŸÑŸÅÿ±ŸäŸÉ", de_example:"Der Lift ist offen.", darija_example:"ÿßŸÑÿ™ŸÑŸÅÿ±ŸäŸÉ ŸÖÿ≠ŸÑŸàŸÑ." },
      { word:"Mittelalter", pos:"N", ar:"ÿßŸÑÿπÿµŸàÿ± ÿßŸÑŸàÿ≥ÿ∑Ÿâ", darija:"ŸàŸÇÿ™ ŸÇÿØŸäŸÖ ÿ®ÿ≤ÿßŸÅ", de_example:"Das Mittelalter war lang.", darija_example:"ŸáÿØÿßŸÉ ÿßŸÑŸàŸÇÿ™ ŸÇÿØŸäŸÖ ÿ®ÿ≤ÿßŸÅ." },
      { word:"Netzwerk", pos:"N", ar:"ÿ¥ÿ®ŸÉÿ© ÿπŸÑÿßŸÇÿßÿ™", darija:"ÿ¥ÿ®ŸÉÿ©", de_example:"Ich habe ein Netzwerk.", darija_example:"ÿπŸÜÿØŸä ÿ¥ÿ®ŸÉÿ© ÿØŸäÿßŸÑ ÿßŸÑŸÜÿßÿ≥." },
      { word:"Panorama", pos:"N", ar:"ŸÖŸÜÿ∏ÿ± ÿ¥ÿßŸÖŸÑ", darija:"ŸÖŸÜÿ∏ÿ± Ÿàÿßÿ≥ÿπ", de_example:"Das Panorama ist sch√∂n.", darija_example:"ÿßŸÑŸÖŸÜÿ∏ÿ± Ÿàÿßÿ≥ÿπ Ÿàÿ≤ŸàŸäŸÜ." },
      { word:"Prozess", pos:"N", ar:"ÿπŸÖŸÑŸäÿ© ÿ™ÿ∑ŸàŸëÿ±", darija:"ÿπŸÖŸÑŸäÿ©", de_example:"Der Prozess dauert lange.", darija_example:"ÿßŸÑÿπŸÖŸÑŸäÿ© ÿÆÿ∞ÿßÿ™ ŸàŸÇÿ™." },
      { word:"Sage", pos:"N", ar:"ŸÇÿµÿ© ŸÇÿØŸäŸÖÿ©", darija:"ÿ≠ŸÉÿßŸäÿ© ŸÇÿØŸäŸÖÿ©", de_example:"Die Sage ist interessant.", darija_example:"ÿßŸÑÿ≠ŸÉÿßŸäÿ© ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ≤ŸàŸäŸÜÿ©." }
    ];

    function normalizeWord(s){ return String(s||'').trim().toLowerCase().replace(/[.,;:!?()"'‚Äû‚Äú‚Äù‚Äô]/g,'').normalize("NFD").replace(/[\u0300-\u036f]/g,""); }
    const QAMOS = {};
    RAW_ENTRIES.forEach(e => { QAMOS[normalizeWord(e.word)] = e; });
    function lookupB1(w){ return QAMOS[normalizeWord(w)] || null; }

    // ========= ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ Ÿàÿ™ÿ¨ÿßŸàÿ® ÿßŸÑÿ¥ÿßÿ¥ÿßÿ™ =========
    let boxes = [];
    let settings = { numBoxes: 12, columns: 3, boxSize: 'normal', showBack: false };

    const grid = document.getElementById('grid');
    const numBoxesInput = document.getElementById('numBoxes');
    const numBoxesValue = document.getElementById('numBoxesValue');
    const columnsSelect = document.getElementById('columns');
    const boxSizeSelect = document.getElementById('boxSize');
    const showBackCheckbox = document.getElementById('showBack');

    function applyBoxCssSize(){
      const sizes = { small: { app: '900px', boxH: '220px' }, normal:{ app: '1100px', boxH: '260px' }, large: { app: '1400px', boxH: '310px' } };
      const conf = sizes[settings.boxSize] || sizes.normal;
      document.documentElement.style.setProperty('--app-max-w', conf.app);
      document.documentElement.style.setProperty('--box-h', conf.boxH);
    }

    function calculateResponsiveColumns() {
      let userCols = parseInt(settings.columns, 10);
      let screenW = window.innerWidth;
      if (screenW <= 550) return 1; 
      if (screenW <= 850) return Math.min(userCols, 2); 
      if (screenW <= 1100) return Math.min(userCols, 3); 
      return userCols; 
    }

    function ensureBoxesLength(){
      while (boxes.length < settings.numBoxes) {
        boxes.push({ word:'', example:'', posOverride:'', note:'', arTextManual:'', darTextManual:'', arabicExampleManual:'', darijaExampleManual:'', darijaExampleB1:'' });
      }
      if (boxes.length > settings.numBoxes) boxes = boxes.slice(0, settings.numBoxes);
    }

    function autoFitTextarea(textarea, min=12, max=18){
      textarea.style.fontSize = max + 'px';
      for (let s=max; s>=min; s--){
        textarea.style.fontSize = s + 'px';
        if (textarea.scrollHeight <= textarea.clientHeight + 2) break;
      }
    }

    // ========= ÿ®ŸÜÿßÿ° ÿßŸÑŸÖÿ±ÿ®ÿπÿßÿ™ (ŸÅŸä ÿßŸÑÿ¥ÿßÿ¥ÿ©) =========
    function createBoxElement(index){
      const data = boxes[index];
      const box = document.createElement('div'); box.className = 'box';
      const flip = document.createElement('div'); flip.className = 'flip-card' + (settings.showBack ? ' flipped' : '');

      const front = document.createElement('div'); front.className = 'flip-side flip-front';
      const wordWrap = document.createElement('div'); wordWrap.className = 'frontWordWrap';
      const wordTA = document.createElement('textarea'); wordTA.className = 'wordInput'; wordTA.placeholder = 'Wort'; wordTA.value = data.word; wordTA.rows=2;
      wordWrap.appendChild(wordTA);

      const exWrap = document.createElement('div'); exWrap.className = 'exampleWrap';
      const exHeader = document.createElement('div'); exHeader.className = 'exampleHeader';
      const exLabel = document.createElement('div'); exLabel.className = 'exampleLabel'; exLabel.textContent = 'Beispiel';
      const autoBtn = document.createElement('button'); autoBtn.className = 'autoBtn'; autoBtn.textContent = '‚öô Automatik';
      const autoMsg = document.createElement('div'); autoMsg.className = 'autoMsg';
      exHeader.appendChild(exLabel); exHeader.appendChild(autoBtn);
      const exTA = document.createElement('textarea'); exTA.className = 'explainInput'; exTA.placeholder = 'Beispiel hier...'; exTA.value = data.example;
      exWrap.appendChild(exHeader); exWrap.appendChild(autoMsg); exWrap.appendChild(exTA);
      front.appendChild(wordWrap); front.appendChild(exWrap);

      const back = document.createElement('div'); back.className = 'flip-side flip-back';
      const posBadge = document.createElement('div'); posBadge.className = 'posBadge';
      
      const topRow = document.createElement('div'); topRow.className = 'backTopRow';
      const arCenter = document.createElement('textarea'); arCenter.className = 'arabicCenter'; arCenter.placeholder = 'ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿ© ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©...'; arCenter.value = data.arTextManual;
      const darSide = document.createElement('textarea'); darSide.className = 'darijaSide'; darSide.placeholder = 'ÿ®ÿßŸÑÿØÿßÿ±ÿ¨ÿ©...'; darSide.value = data.darTextManual;
      topRow.appendChild(darSide); topRow.appendChild(arCenter);

      const noteWrap = document.createElement('div'); noteWrap.className = 'backNoteWrap';
      const exL = document.createElement('div'); exL.className = 'noteLabel'; exL.textContent = 'ÿ£ŸÉÿ™ÿ® ŸÖÿ´ÿßŸÑŸÉ ŸáŸÜÿß:';
      const arExTA = document.createElement('textarea'); arExTA.className = 'noteInput'; arExTA.placeholder = 'ŸÖÿ´ÿßŸÑ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©...'; arExTA.value = data.arabicExampleManual;
      const darExTA = document.createElement('textarea'); darExTA.className = 'noteInput'; darExTA.placeholder = 'ŸÖÿ´ÿßŸÑ ÿ®ÿßŸÑÿØÿßÿ±ÿ¨ÿ©...'; darExTA.value = data.darijaExampleManual;
      
      const extraNoteWrap = document.createElement('div'); extraNoteWrap.style.display = 'none'; extraNoteWrap.style.flexDirection = 'column'; extraNoteWrap.style.gap='4px'; extraNoteWrap.style.borderTop='1px dashed rgba(255,255,255,0.1)'; extraNoteWrap.style.marginTop='6px'; extraNoteWrap.style.paddingTop='6px';
      const nL = document.createElement('div'); nL.className = 'noteLabel'; nL.textContent = 'ŸÖŸÑÿßÿ≠ÿ∏ÿ©:';
      const noteTA = document.createElement('textarea'); noteTA.className = 'noteInput'; noteTA.placeholder = 'ŸÖŸÑÿßÿ≠ÿ∏ÿ©...'; noteTA.value = data.note;
      extraNoteWrap.appendChild(nL); extraNoteWrap.appendChild(noteTA);
      
      noteWrap.appendChild(exL); noteWrap.appendChild(arExTA); noteWrap.appendChild(darExTA); noteWrap.appendChild(extraNoteWrap);
      back.appendChild(posBadge); back.appendChild(topRow); back.appendChild(noteWrap);

      function render(){
        const b1 = lookupB1(wordTA.value);
        posBadge.textContent = data.posOverride || (b1?b1.pos:'N/V/A');
        arCenter.value = data.arTextManual || (b1?b1.ar:'');
        darSide.value = data.darTextManual || (b1?b1.darija:'');

        const manualDarEx = (data.darijaExampleManual || '').trim();
        const autoDarEx   = (data.darijaExampleB1 || '').trim();
        darExTA.value = manualDarEx || autoDarEx || '';
        arExTA.value = data.arabicExampleManual || '';
        extraNoteWrap.style.display = (b1 || data.note.trim() !== '') ? 'flex' : 'none';
        
        [wordTA, exTA, arCenter, darSide, arExTA, darExTA, noteTA].forEach(t => autoFitTextarea(t));
      }

      autoBtn.onclick = (e) => {
        e.stopPropagation();
        const b1 = lookupB1(wordTA.value);
        if(!b1) { autoMsg.textContent = "Not in dict"; return; }
        data.posOverride = b1.pos; data.example = b1.de_example; exTA.value = b1.de_example;
        data.darijaExampleB1 = b1.darija_example; autoMsg.textContent = "‚úÖ"; render(); save();
      };
      
      posBadge.onclick = (e) => { e.stopPropagation(); data.posOverride = data.posOverride==='V'?'N':data.posOverride==='N'?'A':'V'; render(); save(); };

      const binds = [ [wordTA,'word'], [exTA,'example'], [arCenter,'arTextManual'], [darSide,'darTextManual'], [arExTA,'arabicExampleManual'], [darExTA,'darijaExampleManual'], [noteTA,'note'] ];
      binds.forEach(([el, key]) => { el.oninput = () => { data[key] = el.value; autoFitTextarea(el); save(); }; });

      box.onclick = (e) => { if(!['TEXTAREA','INPUT','BUTTON'].includes(e.target.tagName)) flip.classList.toggle('flipped'); };
      setTimeout(render, 10);
      flip.appendChild(front); flip.appendChild(back); box.appendChild(flip);
      return box;
    }

    function updateGrid(){
      ensureBoxesLength();
      applyBoxCssSize();
      grid.innerHTML = '';
      let safeCols = calculateResponsiveColumns();
      grid.style.gridTemplateColumns = `repeat(${safeCols}, minmax(0, 1fr))`;
      boxes.forEach((_, i) => grid.appendChild(createBoxElement(i)));
    }

    // ========= ÿßŸÑÿ≠ŸÅÿ∏ =========
    function save(){ localStorage.setItem('dms_boxes', JSON.stringify(boxes)); localStorage.setItem('dms_settings', JSON.stringify(settings)); }
    function load(){ try{ if(localStorage.getItem('dms_boxes')) boxes = JSON.parse(localStorage.getItem('dms_boxes')); if(localStorage.getItem('dms_settings')) settings = {...settings, ...JSON.parse(localStorage.getItem('dms_settings'))}; }catch(e){} }

    numBoxesInput.oninput = () => { settings.numBoxes = numBoxesInput.value; numBoxesValue.textContent = numBoxesInput.value; updateGrid(); save(); };
    columnsSelect.onchange = () => { settings.columns = columnsSelect.value; updateGrid(); save(); };
    boxSizeSelect.onchange = () => { settings.boxSize = boxSizeSelect.value; updateGrid(); save(); };
    showBackCheckbox.onchange = () => { settings.showBack = showBackCheckbox.checked; updateGrid(); save(); };
    document.getElementById('resetBtn').onclick = () => { boxes=[]; updateGrid(); save(); };
    langBtn.onclick = () => { lang = lang==='de'?'en':'de'; applyI18n(); save(); };
    window.addEventListener('resize', () => { requestAnimationFrame(updateGrid); });

    document.getElementById('waBtn').onclick = () => document.getElementById('waPopup').classList.toggle('open');
    document.getElementById('waClose').onclick = () => document.getElementById('waPopup').classList.remove('open');
    document.getElementById('waSend').onclick = () => { window.open(`https://wa.me/212690010348?text=${encodeURIComponent(document.getElementById('waInput').value || 'Hallo Said!')}`, '_blank'); };

    // =========================================================
    // ‚úÖ PDF GENERATOR PRO (MIRROR EFFECT + EXACT DIMENSIONS)
    // =========================================================
    document.getElementById('downloadPdfBtn').onclick = async () => {
      const loader = document.getElementById('pdfLoading');
      try {
        loader.style.display = 'flex';
        clearError();
        const { jsPDF } = window.jspdf;
        // ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ PDF ÿ®ÿ≠ÿ¨ŸÖ A4 ÿ≠ŸÇŸäŸÇŸä
        const pdf = new jsPDF("p", "mm", "a4");
        
        ensureBoxesLength();
        const cols = Math.min(Math.max(1, settings.columns), 4);
        
        // ŸÇŸäÿßÿ≥ÿßÿ™ ÿßŸÑŸàÿ±ŸÇÿ© ÿßŸÑŸÖŸÑŸäŸÖÿ™ÿ±Ÿäÿ©
        const pageW = 210; const pageH = 297;
        const pad = 12; const gap = 4;
        const innerW = pageW - (2 * pad);
        const boxMmW = (innerW - (gap * (cols - 1))) / cols;
        const boxMmH = boxMmW * 1.1; // ÿ∑ŸàŸÑ ÿßŸÑŸÖÿ±ÿ®ÿπ Ÿäÿ™ŸÜÿßÿ≥ÿ® ŸÖÿπ ÿßŸÑÿπÿ±ÿ∂

        const pdfStage = document.getElementById('pdfStage');

        // Ÿàÿ∏ŸäŸÅÿ© ÿ®ŸÜÿßÿ° ÿµŸÅÿ≠ÿ© PDF ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
        function buildPage(mode, startIndex, count, headerH){
          pdfStage.innerHTML = "";
          
          const headerArea = document.createElement("div");
          headerArea.className = "pdfHeaderArea";
          headerArea.style.setProperty("--header-h", headerH + "mm");
          
          if (mode === "front" && headerH > 0) {
            const title = document.createElement("div"); title.className = "pdfBigTitle"; title.textContent = "Deutsch mit Said ist einfacher, als du denkst.";
            const meta = document.createElement("div"); meta.className = "pdfMeta";
            const nm = (document.getElementById('name').value || "").trim();
            const dt = (document.getElementById('date').value || "").trim();
            const tp = (document.getElementById('topic').value || "").trim();
            meta.innerHTML = `<span>Name: ${nm||"‚Äî"}</span><span>Datum: ${dt||"‚Äî"}</span><span>Thema: ${tp||"‚Äî"}</span>`;
            headerArea.appendChild(title);
            headerArea.appendChild(meta);
          }
          pdfStage.appendChild(headerArea);

          const g = document.createElement("div"); 
          g.className = "pdfGrid";
          pdfStage.style.setProperty("--pdfCols", String(cols));
          pdfStage.style.setProperty("--pdfBoxW", boxMmW + "mm");
          pdfStage.style.setProperty("--pdfBoxH", boxMmH + "mm");
          pdfStage.style.setProperty("--pdfGap", gap + "mm");

          let rows = Math.ceil(count / cols);
          let pageData = boxes.slice(startIndex, startIndex + count);

          // ‚¨ÖÔ∏è ŸáŸÜÿß ŸÉÿßŸäŸÜ ÿßŸÑÿ≥ÿ± ÿØŸäÿßŸÑ ÿßŸÑÿ∑ÿ®ÿßÿπÿ© (Mirror Effect) ‚û°Ô∏è
          for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
              
              // ÿ™ÿ≠ÿØŸäÿØ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©: Ÿàÿßÿ¥ ÿ∫ÿßÿØŸäÿ© ÿπÿßÿØŸäÿ©ÿå ŸàŸÑÿß ŸÖŸÇŸÑŸàÿ®ÿ© (ÿ•ŸÑŸâ ŸÉÿßŸÜ ÿ∏Ÿáÿ± ÿßŸÑŸàÿ±ŸÇÿ©)
              let itemIndex = (mode === "front") ? (r * cols + c) : (r * cols + (cols - 1 - c));
              
              const card = document.createElement("div");
              card.className = "pdfCard";
              
              if (itemIndex >= pageData.length) {
                // ŸäŸÑÿß ŸÉÿßŸÜ ÿßŸÑÿ®ŸÑÿßÿµÿ© ÿÆÿßŸàŸäÿ©ÿå ŸÉÿØŸäÿ±Ÿà ÿ®ÿ∑ÿßŸÇÿ© ÿ¥ŸÅÿßŸÅÿ© ÿ®ÿßÿ¥ ŸÜÿ≠ÿßŸÅÿ∏Ÿà ÿπŸÑŸâ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ¥ÿ®ŸÉÿ©
                card.classList.add("empty");
              } else {
                const d = pageData[itemIndex] || {};
                const inner = document.createElement("div"); inner.className = "pdfCardInner";

                if (mode === "front"){
                  inner.innerHTML = `<div class="pdfWordWrap"><div class="pdfWord">${d.word||""}</div></div><div class="pdfLine"></div><div class="pdfExample">${d.example||""}</div>`;
                } else {
                  const b1 = lookupB1(d.word);
                  const arText = d.arTextManual || (b1?b1.ar:"");
                  const darText = d.darTextManual || (b1?b1.darija:"");
                  const darEx = d.darijaExampleManual || d.darijaExampleB1 || "";
                  
                  inner.innerHTML = `
                    <div class="pdfAr">${arText}</div>
                    <div class="pdfDar">${darText}</div>
                    ${darEx ? `<div class="pdfLine"></div><div class="pdfNote">ŸÖÿ´ÿßŸÑ ÿ®ÿßŸÑÿØÿßÿ±ÿ¨ÿ©: ${darEx}</div>` : ''}
                    ${d.arabicExampleManual ? `<div class="pdfLine"></div><div class="pdfNote">ŸÖÿ´ÿßŸÑ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©: ${d.arabicExampleManual}</div>` : ''}
                    ${d.note ? `<div class="pdfLine"></div><div class="pdfNote">ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ${d.note}</div>` : ''}
                  `;
                }
                card.appendChild(inner);
              }
              g.appendChild(card);
            }
          }
          pdfStage.appendChild(g);
        }

        let index = 0; 
        let isFirstPage = true;

        while (index < boxes.length) {
          const headerH = isFirstPage ? 20 : 0;
          const innerH = pageH - (2 * pad);
          const availableGridH = innerH - headerH - 4; // 4mm margin bottom for header
          const rowsPerPage = Math.max(1, Math.floor(availableGridH / (boxMmH + gap)));
          const perPage = cols * rowsPerPage;

          // 1. ÿßŸÑÿ™ŸÇÿßÿ∑ Ÿàÿ®ŸÜÿßÿ° Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸàÿ±ŸÇÿ© (Front)
          buildPage("front", index, perPage, headerH);
          await new Promise(r => setTimeout(r, 150)); // ÿ•ÿπÿ∑ÿßÿ° ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸàŸÇÿ™ ŸÑÿ±ÿ≥ŸÖ ÿßŸÑÿÆÿ∑Ÿàÿ∑
          const c1 = await html2canvas(pdfStage, { scale: 3, useCORS: true, backgroundColor: "#ffffff" });
          if(!isFirstPage) pdf.addPage();
          pdf.addImage(c1.toDataURL("image/jpeg", 0.95), "JPEG", 0, 0, 210, 297);

          // 2. ÿßŸÑÿ™ŸÇÿßÿ∑ Ÿàÿ®ŸÜÿßÿ° ÿ∏Ÿáÿ± ÿßŸÑŸàÿ±ŸÇÿ© (Back)
          pdf.addPage();
          buildPage("back", index, perPage, headerH);
          await new Promise(r => setTimeout(r, 150));
          const c2 = await html2canvas(pdfStage, { scale: 3, useCORS: true, backgroundColor: "#ffffff" });
          pdf.addImage(c2.toDataURL("image/jpeg", 0.95), "JPEG", 0, 0, 210, 297);

          index += perPage;
          isFirstPage = false;
        }

        pdf.save("Deutsch_mit_Said.pdf");
      } catch (e) {
        showError("Fehler beim PDF: " + e.message);
      } finally {
        loader.style.display = 'none';
      }
    };

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      load();
      numBoxesInput.value = settings.numBoxes; numBoxesValue.textContent = settings.numBoxes;
      columnsSelect.value = settings.columns; boxSizeSelect.value = settings.boxSize;
      showBackCheckbox.checked = settings.showBack;
      applyI18n();
      updateGrid();
    });
  </script>
</body>
</html>
