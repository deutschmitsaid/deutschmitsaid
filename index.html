<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Deutsch mit Said ‚Äì Vokabelblatt</title>

  <!-- ‚úÖ jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- ‚úÖ html2canvas (for perfect A4 pages, NO slicing bars) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- ‚úÖ Arabic font for html2canvas capture -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --carbon:#0B0D0E;
      --carbon2:#0F1412;
      --ink:#EAF2EE;
      --muted:#A7B6AE;

      --moss:#2E5E3A;
      --moss2:#3E7A4B;

      --brg:#004225;
      --brg2:#0B5A36;

      --shadow: 0 16px 60px rgba(0,0,0,0.45);
      --glass1: rgba(255,255,255,0.10);
      --glass2: rgba(255,255,255,0.06);

      --box: clamp(150px, 34vw, 220px);

      --wa:#25D366;
      --waDark:#0b5a46;

      /* ‚úÖ reserve height for fixed controls */
      --controlsH: 92px;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      font-family: Arial, sans-serif;
      margin:0;
      color:var(--ink);
      background: linear-gradient(180deg, var(--carbon), var(--carbon2));
      overflow-x:hidden;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    /* aura */
    body::before{
      content:"";
      position: fixed;
      inset: -35%;
      z-index: -2;
      pointer-events:none;
      background:
        radial-gradient(60% 50% at 12% 22%, rgba(46,94,58,0.55), transparent 62%),
        radial-gradient(55% 50% at 88% 28%, rgba(0,66,37,0.48), transparent 62%),
        radial-gradient(50% 45% at 55% 85%, rgba(62,122,75,0.38), transparent 62%),
        radial-gradient(45% 40% at 25% 78%, rgba(46,94,58,0.26), transparent 60%),
        radial-gradient(55% 55% at 70% 10%, rgba(0,66,37,0.20), transparent 60%);
      filter: blur(26px) saturate(1.15);
      transform: translate3d(0,0,0);
      animation: auraDrift 18s ease-in-out infinite alternate;
      opacity: .92;
    }
    @keyframes auraDrift{
      0%   { transform: translate3d(-2%, -1%, 0) scale(1.02) rotate(0deg); }
      45%  { transform: translate3d( 2%,  2%, 0) scale(1.06) rotate(1deg); }
      100% { transform: translate3d(-1%,  3%, 0) scale(1.03) rotate(-1deg); }
    }
    @media (prefers-reduced-motion: reduce){
      body::before{ animation:none; }
    }

    body::after{
      content:"";
      position: fixed;
      inset:0;
      z-index:-1;
      pointer-events:none;
      background:
        repeating-radial-gradient(circle at 20% 30%,
          rgba(255,255,255,0.030) 0 1px,
          rgba(0,0,0,0) 1px 6px),
        repeating-radial-gradient(circle at 80% 70%,
          rgba(255,255,255,0.020) 0 1px,
          rgba(0,0,0,0) 1px 7px);
      opacity:.30;
      mix-blend-mode: overlay;
    }

    /* ===== APP ===== */
    #app{
      max-width: 1100px;
      margin:0 auto;
      padding:16px;
      padding-top: calc(var(--controlsH) + 18px);
    }

    /* ---------- HEADER ---------- */
    .topbar{
      position: relative;
      z-index: 5;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px;
      border-radius: 18px;
      background: linear-gradient(180deg, var(--glass1), var(--glass2));
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      flex-wrap: wrap;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width: 220px;
      flex: 1 1 220px;
    }

    .brandTitle{
      font-size: 22px;
      font-weight: 900;
      line-height:1.1;
      background: linear-gradient(90deg, #d7f7e6, rgba(62,122,75,0.95), rgba(0,66,37,0.95));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 0 22px rgba(46,94,58,0.22);
    }

    .brandSub{
      font-size: 13px;
      color: var(--muted);
      font-weight: 800;
    }

    .topActions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex: 1 1 260px;
      min-width: 260px;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,0.16);
      border: 1px solid rgba(255,255,255,0.12);
      flex-wrap: wrap;
      width: min(560px, 100%);
      justify-content:flex-end;
    }

    .pill input{
      padding:10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      outline:none;
      background: rgba(0,0,0,0.24);
      color: var(--ink);
      font-size: 14px;
      font-weight: 800;
      min-width: 0;
      flex: 1 1 150px;
      max-width: 100%;
    }
    .pill input::placeholder{ color: rgba(234,242,238,0.55); }
    .pill input:focus{
      border-color: rgba(62,122,75,0.70);
      box-shadow: 0 0 0 4px rgba(62,122,75,0.18);
    }

    .btn{
      border: none;
      cursor: pointer;
      padding:10px 14px;
      border-radius: 999px;
      font-weight: 900;
      transition: transform .12s ease, opacity .12s ease, filter .12s ease;
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
      -webkit-tap-highlight-color: transparent;
      color: var(--ink);
    }
    .btn:hover{ transform: translateY(-1px); opacity:.98; filter: brightness(1.02); }
    .btn:active{ transform: translateY(0px) scale(0.99); }

    .btnPrimary{
      background: linear-gradient(90deg, var(--brg), var(--moss2));
      color:#EAF2EE;
      box-shadow: 0 12px 28px rgba(0,66,37,0.35);
    }
    .btnDanger{
      background: linear-gradient(90deg, #7a1b1b, #b45309);
      color:#fff;
      box-shadow: 0 12px 28px rgba(0,0,0,0.35);
    }
    .btnLang{
      background: linear-gradient(90deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--ink);
      box-shadow: 0 12px 28px rgba(0,0,0,0.28);
    }

    /* ---------- CONTROLS (fixed) ---------- */
    #controls{
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: min(1100px, calc(100vw - 24px));
      z-index: 999;
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      padding:14px;
      border-radius: 18px;
      justify-content:center;
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
    }

    .control-group{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:center; }
    .control-group label{
      font-weight: 900;
      color: rgba(234,242,238,0.92);
      font-size: 14px;
    }

    select, input[type="range"]{
      padding:10px 12px;
      border:1px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      background: rgba(0,0,0,0.20);
      color: var(--ink);
      font-weight: 900;
      max-width: 100%;
      outline: none;
    }

    #debug{
      margin: 10px 0 0;
      text-align:center;
      font-size: 14px;
      color: rgba(234,242,238,0.82);
      font-weight: 900;
    }
    .error{
      display:none;
      margin-top:8px;
      text-align:center;
      color:#ffb4b4;
      font-weight:900;
      padding: 0 10px;
    }

    /* ---------- GRID ---------- */
    #grid{
      margin-top: 16px;
      display:grid;
      justify-content:center;
      padding:10px;
      border-radius: 18px;
      position:relative;
      gap: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.08);
    }

    .box{
      width: var(--box);
      height: var(--box);
      border-radius: 16px;
      position:relative;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.10);
      background:
        radial-gradient(700px 260px at 10% 0%, rgba(62,122,75,0.10), transparent 55%),
        radial-gradient(700px 260px at 90% 0%, rgba(0,66,37,0.10), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
      contain: content;
      touch-action: manipulation;
    }

    .flip-card{
      width:100%; height:100%;
      position:relative;
      transform-style:preserve-3d;
      transition: transform .55s ease;
    }
    .flip-card.flipped{ transform: rotateY(180deg); }

    .flip-side{
      position:absolute; inset:0;
      backface-visibility:hidden;
      display:flex; flex-direction:column;
      padding:14px;
      gap:10px;
    }
    .flip-back{
      transform: rotateY(180deg);
      direction: rtl;
      text-align:right;
    }

    /* ‚úÖ word centered in box front */
    .frontWordWrap{
      flex: 1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0;
      min-height: 52%;
    }
    /* ‚úÖ Cute / responsive word typography */
    .wordInput{
      width:100%;
      border:none;
      outline:none;
      resize:none;
      background:transparent;
      color: var(--ink);
      font-weight: 900;
      font-size: clamp(16px, 1.35vw, 22px);
      line-height:1.22;
      text-align:center;
      overflow:hidden;
      margin:0;
      padding: 0 6px;
      min-height: 40px;
      display:flex;
      align-items:center;
      letter-spacing: .2px;
      text-shadow: 0 0 18px rgba(46,94,58,0.14);
    }

    .exampleWrap{
      border-top: 1px solid rgba(255,255,255,0.10);
      padding-top: 10px;
      min-height: 42%;
      display:flex; flex-direction:column;
      gap:6px;
    }

    .exampleHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .exampleLabel{
      font-size:12px;
      color: rgba(234,242,238,0.65);
      font-weight:900;
      text-align:left;
      direction:ltr;
    }

    /* ‚úÖ Auto button (pro, small) */
    .autoBtn{
      border:none;
      cursor:pointer;
      padding:6px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 11px;
      color: #e9fff4;
      background: linear-gradient(90deg, rgba(0,66,37,0.92), rgba(62,122,75,0.92));
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 10px 18px rgba(0,0,0,0.25);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      direction:ltr;
      white-space:nowrap;
    }
    .autoBtn:active{ transform: scale(0.98); }

    .autoMsg{
      font-size: 11px;
      font-weight: 900;
      color: rgba(234,242,238,0.62);
      line-height: 1.25;
      min-height: 14px;
      direction:ltr;
      text-align:left;
    }

    .explainInput{
      border:none; outline:none; resize:none;
      background:transparent;
      color: rgba(234,242,238,0.92);
      font-size: clamp(12px, 1vw, 13px);
      line-height:1.35;
      text-align:left;
      overflow:hidden;
      flex:1;
    }

    .posBadge{
      display:inline-flex;
      align-self:flex-start;
      padding:4px 10px;
      border-radius:999px;
      font-size: 11px;
      font-weight: 900;
      background: rgba(62,122,75,0.18);
      border: 1px solid rgba(62,122,75,0.28);
      color: #d7f7e6;
      direction:ltr;
      user-select:none;
      cursor:pointer;
    }

    .backTopRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-top: 2px;
      min-height: 64px;
    }

    .arabicCenter{
      flex: 1;
      text-align:center;
      font-size: clamp(18px, 1.6vw, 22px);
      font-weight: 700;
      line-height: 1.7;
      direction: rtl;
      color: #e9fff4;
      word-break: break-word;
      opacity: .95;
    }

    .darijaSide{
      width: 40%;
      text-align:right;
      font-size: clamp(13px, 1.1vw, 15px);
      font-weight: 700;
      line-height: 1.65;
      direction: rtl;
      word-break: break-word;
      color: rgba(234,242,238,0.88);
      opacity: .95;
    }

    .backNoteWrap{
      margin-top: 6px;
      padding-top: 8px;
      border-top: 1px solid rgba(255,255,255,0.10);
      display:flex;
      flex-direction:column;
      gap:8px;
      flex: 1;
      min-height: 0;
    }

    .noteLabel{
      font-size: 12px;
      font-weight: 800;
      opacity: .90;
      direction: rtl;
      text-align: right;
      color: rgba(234,242,238,0.90);
    }

    .noteInput{
      border:none;
      outline:none;
      resize:none;
      background:transparent;
      color: rgba(234,242,238,0.92);
      font-size: 14px;
      line-height: 1.6;
      min-height: 70px;
      text-align:right;
      direction: rtl;
      overflow:hidden;
    }

    /* ‚úÖ darija example line (back) */
    .darijaExampleTA{
      border:none;
      outline:none;
      resize:none;
      background:transparent;
      color: rgba(234,242,238,0.78);
      font-size: 13px;
      font-weight: 700;
      line-height: 1.7;
      min-height: 44px;
      text-align:right;
      direction: rtl;
      overflow:hidden;
      opacity: .95;
    }

    /* WhatsApp */
    #waBtn{
      position: fixed;
      right: 18px;
      bottom: 18px;
      width: 54px;
      height: 54px;
      border-radius: 999px;
      background: var(--wa);
      border: none;
      cursor: pointer;
      box-shadow: 0 16px 30px rgba(0,0,0,0.35);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 9999;
      -webkit-tap-highlight-color: transparent;
    }
    #waBtn:active{ transform: scale(0.98); }
    #waBtn svg{ width: 26px; height: 26px; fill: #fff; }

    #waPopup{
      position: fixed;
      right: 18px;
      bottom: 86px;
      width: 320px;
      max-width: calc(100vw - 36px);
      border-radius: 14px;
      overflow:hidden;
      box-shadow: 0 18px 50px rgba(0,0,0,0.35);
      background:#fff;
      z-index: 9999;
      display:none;
    }
    #waPopup.open{ display:block; }
    .waHeader{
      background: var(--waDark);
      padding: 12px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      color:#fff;
    }
    .waAvatar{
      width: 40px; height: 40px;
      border-radius: 999px;
      object-fit: cover;
      border: 2px solid rgba(255,255,255,0.35);
      background:#0f172a;
      user-select:none;
      -webkit-user-select:none;
    }
    .waTitle{ font-weight: 900; line-height:1.1; }
    .waSub{ font-size: 12px; opacity: .9; margin-top: 2px; }
    .waClose{
      margin-left:auto;
      border:none;
      background: rgba(255,255,255,0.12);
      color:#fff;
      width: 32px; height: 32px;
      border-radius: 10px;
      cursor:pointer;
      font-weight: 900;
    }
    .waBody{ padding: 12px; background: #f6f7f8; }
    .waBubble{
      background:#fff;
      border-radius: 12px;
      padding: 10px 10px;
      border: 1px solid rgba(2,6,23,0.06);
      font-weight: 800;
      color:#0f172a;
    }
    .waBubble small{ display:block; margin-top:6px; color:#64748b; font-weight:800; }
    .waInputWrap{ margin-top: 10px; display:flex; gap:8px; }
    #waInput{
      flex:1;
      border-radius: 12px;
      border: 1px solid rgba(2,6,23,0.14);
      padding: 10px 10px;
      outline:none;
      font-weight: 800;
      min-width: 0;
    }
    #waSend{
      border:none;
      border-radius: 12px;
      padding: 10px 12px;
      background: var(--wa);
      color:#fff;
      font-weight: 900;
      cursor:pointer;
      white-space: nowrap;
    }

    /* deterrent */
    body, #app{ user-select:none; -webkit-user-select:none; }
    input, textarea{ user-select:text !important; -webkit-user-select:text !important; }

    /* ================= PDF (A4 fixed ‚Äî NO slicing) ================= */
    #pdfStage{
      position: fixed;
      left: -99999px;
      top: -99999px;

      width: 210mm;
      height: 297mm;
      padding: 10mm;

      background:#fff;
      color:#111;
      box-sizing:border-box;
      font-family: Arial, sans-serif;

      display:flex;
      flex-direction:column;
      gap: 4mm;
    }

    .pdfBigTitle{
      margin:0;
      text-align:center;
      font-weight: 900;
      font-size: 18px;
      color:#0B5A36;
      line-height: 1.2;
    }

    .pdfMeta{
      display:flex;
      justify-content:space-between;
      gap: 6mm;
      font-size: 11px;
      font-weight: 900;
      color:#111;
    }
    .pdfMeta span{
      border: 1px solid rgba(0,0,0,0.14);
      border-radius: 999px;
      padding: 2.5mm 4mm;
      background: rgba(0,0,0,0.02);
      white-space: nowrap;
    }

    .pdfGrid{
      margin-top: 2mm;
      display:grid;
      justify-content:center;
      align-content:start;
      gap: var(--pdfGap, 4mm);
      grid-template-columns: repeat(var(--pdfCols, 3), var(--pdfBox, 50mm));
    }

    .pdfCard{
      width: var(--pdfBox, 50mm);
      height: var(--pdfBox, 50mm);
      background:#fff;
      border: 1px solid rgba(0,0,0,0.22);
      border-radius: 14px;
      overflow:hidden;
    }

    .pdfCardInner{
      padding: 12px;
      height: 100%;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      gap: 8px;
      font-family: Arial, sans-serif;
    }

    /* ‚úÖ German word centered (PDF) */
    .pdfWordWrap{
      flex: 1;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }
    .pdfWord{
      font-weight: 900;
      font-size: 16px;
      color:#111;
      white-space: pre-wrap;
    }

    .pdfLine{
      height:1px;
      background: rgba(0,0,0,0.14);
    }

    .pdfExample{
      font-size: 12px;
      line-height: 1.35;
      color:#111;
      white-space: pre-wrap;
      flex: 1;
    }

    .pdfAr{
      direction: rtl;
      text-align: center;
      font-family: "Amiri", Arial, sans-serif;
      font-weight: 700;
      font-size: 18px;
      line-height: 1.7;
      color:#111;
      white-space: pre-wrap;
    }

    .pdfDar{
      direction: rtl;
      text-align: right;
      font-weight: 700;
      font-size: 13px;
      line-height: 1.6;
      color:#111;
      white-space: pre-wrap;
    }

    .pdfNote{
      direction: rtl;
      text-align: right;
      font-size: 12px;
      line-height: 1.6;
      color:#111;
      white-space: pre-wrap;
    }
  </style>

  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32[1].png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16[1].png">
  <link rel="icon" type="image/x-icon" href="favicon[1].ico">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon[1].png">
  <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192[2].png">
  <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512[1].png">
  <link rel="manifest" href="site[1].webmanifest">
</head>

<body>

  <!-- ‚úÖ FIXED CONTROLS -->
  <div id="controls">
    <div class="control-group">
      <label data-i18n="count">Anzahl</label>
      <input type="range" id="numBoxes" min="1" max="200" value="12" step="1">
      <span id="numBoxesValue" style="font-weight:900;">12</span>
    </div>

    <div class="control-group">
      <label data-i18n="cols">Spalten</label>
      <select id="columns">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3" selected>3</option>
        <option value="4">4</option>
      </select>
    </div>

    <div class="control-group">
      <label data-i18n="size">Gr√∂√üe</label>
      <select id="boxSize">
        <option value="small" data-i18n="small">Klein</option>
        <option value="normal" selected data-i18n="normal">Normal</option>
        <option value="large" data-i18n="large">Gro√ü</option>
      </select>
    </div>

    <div class="control-group">
      <label><input type="checkbox" id="showBack"> <span data-i18n="back">R√ºckseite zeigen</span></label>
    </div>

    <button class="btn btnDanger" id="resetBtn" type="button" data-i18n="reset">Alles leeren</button>
    <button class="btn btnPrimary" id="downloadPdfBtn" type="button">PDF erstellen</button>
  </div>

  <div id="app">
    <!-- ‚úÖ HEADER -->
    <div class="topbar" id="topbar">
      <div class="brand">
        <div class="brandTitle">Deutsch mit Said</div>
        <div class="brandSub" data-i18n="subtitle">ist einfacher: w√§hlen ‚Ä¢ schreiben ‚Ä¢ drucken</div>
      </div>

      <div class="topActions">
        <div class="pill">
          <input type="text" id="name" placeholder="Name" inputmode="text">
          <input type="date" id="date">
          <input type="text" id="topic" placeholder="Thema" inputmode="text">
        </div>

        <button class="btn btnLang" id="langBtn" type="button">Deutsch / English</button>
      </div>
    </div>

    <div id="debug">Viel Erfolg</div>
    <div id="errorMsg" class="error"></div>
    <div id="grid"></div>
  </div>

  <!-- ‚úÖ PDF stage (hidden, A4 fixed) -->
  <div id="pdfStage" aria-hidden="true"></div>

  <!-- WhatsApp -->
  <button id="waBtn" aria-label="WhatsApp">
    <svg viewBox="0 0 32 32" aria-hidden="true">
      <path d="M19.11 17.25c-.27-.14-1.6-.79-1.85-.88-.25-.09-.43-.14-.62.14-.18.27-.71.88-.87 1.06-.16.18-.32.21-.59.07-.27-.14-1.16-.43-2.21-1.36-.82-.73-1.38-1.63-1.54-1.9-.16-.27-.02-.42.12-.56.12-.12.27-.32.41-.48.14-.16.18-.27.27-.46.09-.18.05-.34-.02-.48-.07-.14-.62-1.5-.85-2.06-.22-.53-.45-.46-.62-.47h-.53c-.18 0-.48.07-.73.34-.25.27-.96.94-.96 2.29 0 1.35.99 2.65 1.13 2.83.14.18 1.95 2.97 4.73 4.17.66.29 1.18.46 1.58.59.66.21 1.26.18 1.74.11.53-.08 1.6-.65 1.83-1.27.23-.62.23-1.15.16-1.27-.07-.12-.25-.18-.52-.32zM16 3C9.38 3 4 8.38 4 15c0 2.11.55 4.17 1.6 5.99L4 29l8.21-1.56A11.92 11.92 0 0 0 16 27c6.62 0 12-5.38 12-12S22.62 3 16 3zm0 21.7c-1.94 0-3.83-.52-5.47-1.5l-.39-.23-4.87.93.93-4.74-.25-.41A9.69 9.69 0 0 1 6.3 15C6.3 9.64 10.64 5.3 16 5.3S25.7 9.64 25.7 15 21.36 24.7 16 24.7z"/>
    </svg>
  </button>

  <div id="waPopup">
    <div class="waHeader">
      <img class="waAvatar" id="waAvatar" src="said.jpg" alt="Said Lehrer" draggable="false">
      <div>
        <div class="waTitle">Said Lehrer</div>
        <div class="waSub">Deutsch-Fragen? Schreib mir.</div>
      </div>
      <button class="waClose" id="waClose" type="button">√ó</button>
    </div>

    <div class="waBody">
      <div class="waBubble">
        Hi! üëã<br>
        Schick mir deine Frage zu Deutsch.<br>
        <small>ŸÖÿß ÿ™ÿ™ÿ±ÿØÿØÿ¥: ÿ≥ŸàŸÑŸÜŸä Ÿàÿ£ŸÜÿß ŸÜÿ¨ÿßŸàÿ®ŸÉ üòä</small>
      </div>

      <div class="waInputWrap">
        <input id="waInput" type="text" placeholder="Deine Frage‚Ä¶" inputmode="text">
        <button id="waSend" type="button">Send</button>
      </div>
    </div>
  </div>

  <script>
    /* ========= Deterrents (deterrent only) ========= */
    (function(){
      document.addEventListener('contextmenu', e => e.preventDefault());
      document.addEventListener('dragstart', e => e.preventDefault());
      document.addEventListener('keydown', (e) => {
        const k = (e.key || '').toLowerCase();
        if ((e.ctrlKey || e.metaKey) && ['s','u','p','c','x','a'].includes(k)) e.preventDefault();
      });

      const css = document.createElement('style');
      css.textContent = `
        .box::after{
          content:"";
          position:absolute;
          inset:0;
          display:flex;
          align-items:center;
          justify-content:center;
          font-weight:900;
          font-size:14px;
          color: rgba(255,255,255,0.06);
          transform: rotate(-22deg);
          pointer-events:none;
          letter-spacing: .6px;
        }
      `;
      document.head.appendChild(css);
    })();

    // ================= i18n =================
    let lang = 'de';
    const I18N = {
      de: { subtitle:"ist einfacher: w√§hlen ‚Ä¢ schreiben ‚Ä¢ drucken", count:"Anzahl", cols:"Spalten", size:"Gr√∂√üe", small:"Klein", normal:"Normal", large:"Gro√ü", back:"R√ºckseite zeigen", reset:"Alles leeren" },
      en: { subtitle:"made easy: choose ‚Ä¢ write ‚Ä¢ print", count:"Count", cols:"Columns", size:"Size", small:"Small", normal:"Normal", large:"Large", back:"Show back side", reset:"Clear all" }
    };
    const langBtn = document.getElementById('langBtn');
    function updateLangButton(){ langBtn.textContent = (lang === 'de') ? 'Deutsch / English' : 'English / Deutsch'; }
    function applyI18n(){
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if (I18N[lang] && I18N[lang][key]) el.textContent = I18N[lang][key];
      });
      document.querySelector('option[value="small"]').textContent  = I18N[lang].small;
      document.querySelector('option[value="normal"]').textContent = I18N[lang].normal;
      document.querySelector('option[value="large"]').textContent  = I18N[lang].large;
    }

    // ================= Dictionary (A1/A2 empty placeholders + B1 filled) =================
    const QAMOS_A1 = { /* ÿÆŸÑŸäŸá ÿÆÿßŸàŸä ÿØÿßÿ®ÿß: ÿ≤ŸêÿØ A1 ŸáŸÜÿß ŸÖŸÜ ÿ®ÿπÿØ */ };
    const QAMOS_A2 = { /* ÿÆŸÑŸäŸá ÿÆÿßŸàŸä ÿØÿßÿ®ÿß: ÿ≤ŸêÿØ A2 ŸáŸÜÿß ŸÖŸÜ ÿ®ÿπÿØ */ };

    /* ===============================
      QAMOS ENGINE (Clean + Search + Suggest)
      - Dedupe keeps FIRST occurrence
      - Keys are word__pos (normalized)
    ================================ */
    function normalizeStr(s){
      return (s ?? "")
        .toString()
        .trim()
        .toLowerCase()
        .replace(/√§/g,"ae").replace(/√∂/g,"oe").replace(/√º/g,"ue").replace(/√ü/g,"ss")
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    }

    function makeIdKey(word, pos){
      const w = normalizeStr(word);
      const p = normalizeStr(pos);
      if(!p) return w;
      return `${w}__${p}`;
    }

    function safeEntry(entry){
      if(!entry || typeof entry !== "object") return null;
      if(!entry.word) return null;
      const pos = entry.pos ?? "";
      return {
        word: entry.word,
        pos,
        pos_norm: normalizeStr(pos),
        ar: entry.ar ?? "",
        darija: entry.darija ?? "",
        de_example: entry.de_example ?? "",
        darija_example: entry.darija_example ?? ""
      };
    }

    function buildQamos(entries){
      const dict = {};
      const meta = { duplicates: [], collisions: [], invalid: [] };
      const seenWordPos = new Map();

      for(const raw of entries){
        const e = safeEntry(raw);
        if(!e){ meta.invalid.push(raw); continue; }

        const wordNorm = normalizeStr(e.word);
        const posNorm  = e.pos_norm || "";

        if(!seenWordPos.has(wordNorm)) seenWordPos.set(wordNorm, new Set());
        const set = seenWordPos.get(wordNorm);
        const beforeSize = set.size;
        set.add(posNorm);
        if(beforeSize > 0 && set.size > beforeSize){
          meta.collisions.push({ word: e.word, pos: e.pos });
        }

        const key = makeIdKey(e.word, e.pos);
        if(dict[key]){
          meta.duplicates.push({ key, kept: dict[key], dropped: e });
          continue;
        }

        dict[key] = {
          pos: e.pos,
          ar: e.ar,
          darija: e.darija,
          de_example: e.de_example,
          darija_example: e.darija_example
        };
      }

      return { dict, meta };
    }

    function createSearchIndex(dict){
      return Object.entries(dict).map(([key, val]) => {
        const base = key.split("__")[0];
        const pos  = val.pos || "";
        const hay  = normalizeStr([base, pos, val.ar, val.darija, val.de_example, val.darija_example].join(" | "));
        return { key, val, hay, base };
      });
    }

    function normalizeWord(raw){
      return String(raw||'').trim().toLowerCase()
        .replace(/[.,;:!?()"'‚Äû‚Äú‚Äù‚Äô]/g,'')
        .replace(/\s+/g,' ')
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    }

    function stripArticleIfAny(w){
      let s = normalizeWord(w);
      s = s.replace(/^(der\/die\/das|der\/die|die\/der\/das|die\/der|das\/der\/die|das\/der|das\/die)\s+/,'');

      s = s.replace(/^(der|die|das)\s+/, '');
      return s.trim();
    }

    // ====== YOUR RAW_ENTRIES ======
    const RAW_ENTRIES = [
      { word:"Verkehrszeichen", pos:"N", ar:"ÿπŸÑÿßŸÖÿ© ŸÖÿ±Ÿàÿ±", darija:"ÿ®ŸÑÿßŸÉÿ© ÿØŸäÿßŸÑ ÿßŸÑÿ∑ÿ±ŸäŸÇ", de_example:"Das Verkehrszeichen ist wichtig.", darija_example:"ÿ®ŸÑÿßŸÉÿ© ÿßŸÑÿ∑ÿ±ŸäŸÇ ŸÖŸáŸÖÿ©." },
      { word:"Vorfahrt", pos:"N", ar:"ÿ£ŸàŸÑŸàŸäÿ© ŸÖÿ±Ÿàÿ±", darija:"ÿ≠ŸÇ ÿßŸÑŸÖÿ±Ÿàÿ±", de_example:"Er hat Vorfahrt.", darija_example:"ÿπŸÜÿØŸà ÿ≠ŸÇ ÿßŸÑŸÖÿ±Ÿàÿ±." },
      { word:"Kreuzung", pos:"N", ar:"ÿ™ŸÇÿßÿ∑ÿπ ÿ∑ÿ±ŸÇ", darija:"ÿßŸÑŸÉÿ±Ÿàÿßÿ≤Ÿä", de_example:"An der Kreuzung ist eine Ampel.", darija_example:"ŸÅÿßŸÑŸÉÿ±Ÿàÿßÿ≤Ÿä ŸÉÿßŸäŸÜ ÿßŸÑÿ≥ŸäŸÜŸäÿßŸÑ." },
      { word:"Kurve", pos:"N", ar:"ŸÖŸÜÿπÿ∑ŸÅ ÿ∑ÿ±ŸäŸÇ", darija:"ÿßŸÑŸÅŸäÿ±ÿßÿ¨", de_example:"Die Kurve ist gef√§hrlich.", darija_example:"ÿßŸÑŸÅŸäÿ±ÿßÿ¨ ÿÆÿ∑Ÿäÿ±." },
      { word:"Leitplanke", pos:"N", ar:"ÿ≠ÿßÿ¨ÿ≤ ÿ¨ÿßŸÜÿ®Ÿä", darija:"ÿßŸÑÿ≠ÿØŸäÿØÿ© ŸÅÿßŸÑÿ∑ÿ±ŸäŸÇ", de_example:"Das Auto f√§hrt gegen die Leitplanke.", darija_example:"ÿßŸÑÿ∑ŸàŸÖŸàÿ®ŸäŸÑ ÿ∂ÿ±ÿ®ÿßÿ™ ŸÅÿßŸÑÿ≠ÿØŸäÿØÿ© ÿØŸäÿßŸÑ ÿßŸÑÿ∑ÿ±ŸäŸÇ." },
      { word:"Landstra√üe", pos:"N", ar:"ÿ∑ÿ±ŸäŸÇ ÿ±ŸäŸÅŸä", darija:"ÿ∑ÿ±ŸäŸÇ ÿÆÿßÿ±ÿ¨ ÿßŸÑŸÖÿØŸäŸÜÿ©", de_example:"Wir fahren auf der Landstra√üe.", darija_example:"ŸÉŸÜÿ≥ŸàŸÇŸà ŸÅÿ∑ÿ±ŸäŸÇ ÿÆÿßÿ±ÿ¨ ÿßŸÑŸÖÿØŸäŸÜÿ©." },
      { word:"Mitfahrgelegenheit", pos:"N", ar:"ŸÅÿ±ÿµÿ© ÿ±ŸÉŸàÿ®", darija:"ÿ™ŸàÿµŸäŸÑÿ© ŸÖÿπ ÿ¥Ÿä ÿ≠ÿØ", de_example:"Ich suche eine Mitfahrgelegenheit.", darija_example:"ŸÉŸÜŸÇŸÑÿ® ÿπŸÑŸâ ÿ™ŸàÿµŸäŸÑÿ©." },
      { word:"Pendler", pos:"N", ar:"ŸÖÿ≥ÿßŸÅÿ± ŸäŸàŸÖŸä", darija:"ÿßŸÑŸÑŸä ŸÉŸäŸÖÿ¥Ÿä ŸàŸäÿ±ÿ¨ÿπ ŸÑŸÑÿÆÿØŸÖÿ©", de_example:"Der Pendler f√§hrt jeden Tag.", darija_example:"ŸÉŸäŸÖÿ¥Ÿä ŸàŸäÿ±ÿ¨ÿπ ŸÉŸÑ ŸÜŸáÿßÿ±." },
      { word:"Radweg", pos:"N", ar:"ŸÖÿ≥ÿßÿ± ÿØÿ±ÿßÿ¨ÿßÿ™", darija:"ÿ∑ÿ±ŸäŸÇ ÿØŸäÿßŸÑ ÿßŸÑÿ®ŸäŸÉÿßŸÑÿ©", de_example:"Der Radweg ist neu.", darija_example:"ÿ∑ÿ±ŸäŸÇ ÿßŸÑÿ®ŸäŸÉÿßŸÑÿ© ÿ¨ÿØŸäÿØ." },
      { word:"Semesterticket", pos:"N", ar:"ÿ™ÿ∞ŸÉÿ±ÿ© ŸÅÿµŸÑ", darija:"ÿ™ŸäŸÉŸä ÿØŸäÿßŸÑ ÿßŸÑÿ≥ŸÖŸäÿ≥ÿ™ÿ±", de_example:"Ich habe ein Semesterticket.", darija_example:"ÿπŸÜÿØŸä ÿ™ŸäŸÉŸä ÿØŸäÿßŸÑ ÿßŸÑÿ≥ŸÖŸäÿ≥ÿ™ÿ±." },
      { word:"Stau", pos:"N", ar:"ÿßÿ≤ÿØÿ≠ÿßŸÖ ÿ≥Ÿäÿ±", darija:"ÿßŸÑÿ≤ÿ≠ÿßŸÖ", de_example:"Es gibt einen Stau.", darija_example:"ŸÉÿßŸäŸÜ ÿßŸÑÿ≤ÿ≠ÿßŸÖ." },
      { word:"Tempo", pos:"N", ar:"ÿ≥ÿ±ÿπÿ© ŸÖÿ≠ÿØÿØÿ©", darija:"ÿßŸÑÿ≥ÿ±ÿπÿ©", de_example:"Das Tempo ist 50.", darija_example:"ÿßŸÑÿ≥ÿ±ÿπÿ© 50." },
      { word:"Tunnel", pos:"N", ar:"ŸÜŸÅŸÇ ÿ∑ÿ±ŸäŸÇ", darija:"ÿ™ŸàŸÜŸäŸÑ", de_example:"Das Auto f√§hrt durch den Tunnel.", darija_example:"ÿßŸÑÿ∑ŸàŸÖŸàÿ®ŸäŸÑ ÿØÿßÿ≤ÿ™ ŸÖŸÜ ÿßŸÑÿ™ŸàŸÜŸäŸÑ." },
      { word:"√úberholman√∂ver", pos:"N", ar:"ÿπŸÖŸÑŸäÿ© ÿ™ÿ¨ÿßŸàÿ≤", darija:"ÿØŸàÿ≤ÿßŸÜ ÿπŸÑŸâ ÿ¥Ÿä ÿ≠ÿØ", de_example:"Das √úberholman√∂ver ist gef√§hrlich.", darija_example:"ÿØŸàÿ≤ÿßŸÜ ÿπŸÑŸâ ÿ¥Ÿä ÿ≠ÿØ ÿÆÿ∑Ÿäÿ±." },
      { word:"Unfall", pos:"N", ar:"ÿ≠ÿßÿØÿ´ ÿ∑ÿ±ŸäŸÇ", darija:"ÿ≠ÿßÿØÿ´ÿ©", de_example:"Es gibt einen Unfall.", darija_example:"ŸÉÿßŸäŸÜÿ© ÿ≠ÿßÿØÿ´ÿ©." },
      { word:"Verkehr", pos:"N", ar:"ÿ≠ÿ±ŸÉÿ© ŸÖÿ±Ÿàÿ±", darija:"ÿßŸÑÿ≥Ÿäÿ±", de_example:"Der Verkehr ist stark.", darija_example:"ÿßŸÑÿ≥Ÿäÿ± ŸÇŸàŸä." },
      { word:"Verkehrsregel", pos:"N", ar:"ŸÇÿßŸÜŸàŸÜ ŸÖÿ±Ÿàÿ±", darija:"ŸÇÿßŸÜŸàŸÜ ÿßŸÑÿ≥Ÿäÿ±", de_example:"Ich kenne die Verkehrsregeln.", darija_example:"ŸÉŸÜÿπÿ±ŸÅ ŸÇÿßŸÜŸàŸÜ ÿßŸÑÿ≥Ÿäÿ±." },
      { word:"Verkehrsmittel", pos:"N", ar:"Ÿàÿ≥ŸäŸÑÿ© ŸÜŸÇŸÑ", darija:"Ÿàÿ≥ŸäŸÑÿ© ŸÜŸÇŸÑ", de_example:"Das Verkehrsmittel ist schnell.", darija_example:"Ÿàÿ≥ŸäŸÑÿ© ÿßŸÑŸÜŸÇŸÑ ÿ≥ÿ±Ÿäÿπÿ©." },
    ];

    // ====== Build QAMOS ======
    const { dict: QAMOS_B1_DICT } = buildQamos(RAW_ENTRIES);
    const QAMOS_B1_INDEX = createSearchIndex(QAMOS_B1_DICT);

    // map base -> first matching entry object (for lookupB1)
    const QAMOS_B1_BYWORD = {};
    for(const [k,v] of Object.entries(QAMOS_B1_DICT)){
      const base = k.split("__")[0];
      if(!QAMOS_B1_BYWORD[base]) QAMOS_B1_BYWORD[base] = v;
    }

    // ================= State =================
    let boxes = [];
    let settings = { numBoxes: 12, columns: 3, boxSize: 'normal', showBack: false };

    // ================= DOM =================
    const grid = document.getElementById('grid');
    const numBoxesInput = document.getElementById('numBoxes');
    const numBoxesValue = document.getElementById('numBoxesValue');
    const columnsSelect = document.getElementById('columns');
    const boxSizeSelect = document.getElementById('boxSize');
    const showBackCheckbox = document.getElementById('showBack');
    const resetBtn = document.getElementById('resetBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');

    const pdfStage = document.getElementById('pdfStage');

    const nameInput = document.getElementById('name');
    const dateInput = document.getElementById('date');
    const topicInput = document.getElementById('topic');

    const errorMsg = document.getElementById('errorMsg');
    const debug = document.getElementById('debug');

    // ================= Errors =================
    function log(msg){ debug.textContent = msg; }
    function showError(msg){
      errorMsg.textContent = 'Fehler: ' + msg;
      errorMsg.style.display = 'block';
      log(msg);
    }
    function clearError(){ errorMsg.style.display='none'; errorMsg.textContent=''; }
    window.onerror = function(message, source, lineno){
      showError(String(message) + ' (Zeile ' + lineno + ')');
      return false;
    };

    // ================= Helpers =================
    function lookupB1(wordRaw){
      const raw = String(wordRaw||"").trim();
      if(!raw) return null;

      const norm1 = normalizeWord(raw);
      const norm2 = stripArticleIfAny(raw);
      const norm3 = norm1.replace(/^der\/die\/das\s+/,'').replace(/^der\/die\s+/,'').replace(/^der\s+|^die\s+|^das\s+/,'').trim();
      const tries = [norm1, norm2, norm3].filter(Boolean);

      for(const t of tries){
        const base = normalizeStr(t);
        if(QAMOS_B1_BYWORD[base]) return QAMOS_B1_BYWORD[base];
      }
      return null;
    }

    // ‚ö†Ô∏è DICT / lookupEntry in your original code were referenced.
    // If you already define DICT elsewhere, keep it. If not, only B1 auto will work.

    function guessPOS(wordRaw){
      const w = stripArticleIfAny(wordRaw);
      if (!w) return '';
      const original = String(wordRaw||'').trim();
      if (original && original[0] === original[0]?.toUpperCase() && /[A-Z√Ñ√ñ√ú]/.test(original[0])) return 'N';
      if (/(en|n)$/.test(w)) return 'V';
      return 'A';
    }

    function clampSettings(){
      settings.numBoxes = Math.max(1, Math.min(200, parseInt(settings.numBoxes,10) || 12));
      settings.columns = [1,2,3,4].includes(parseInt(settings.columns,10)) ? parseInt(settings.columns,10) : 3;
      settings.boxSize = ['small','normal','large'].includes(settings.boxSize) ? settings.boxSize : 'normal';
      settings.showBack = !!settings.showBack;

      const w = window.innerWidth || 9999;
      if (w < 360) settings.columns = 1;
      else if (w < 520) settings.columns = Math.min(settings.columns, 2);
    }

    function ensureBoxesLength(){
      if (!Array.isArray(boxes)) boxes = [];
      if (boxes.length < settings.numBoxes){
        for (let i=boxes.length; i<settings.numBoxes; i++){
          boxes.push({
            word:'', example:'', posOverride:'', note:'',
            darijaExampleB1:'', autoUsed:false
          });
        }
      } else if (boxes.length > settings.numBoxes){
        boxes = boxes.slice(0, settings.numBoxes);
      }
      for (let i=0; i<boxes.length; i++){
        boxes[i].darijaExampleB1 = boxes[i].darijaExampleB1 || '';
        boxes[i].autoUsed = !!boxes[i].autoUsed; // ‚úÖ keep boolean
        boxes[i].note = boxes[i].note || '';
      }
    }

    function autoFitTextarea(textarea, min=10, max=16){
      textarea.style.fontSize = max + 'px';
      for (let s=max; s>=min; s--){
        textarea.style.fontSize = s + 'px';
        if (textarea.scrollHeight <= textarea.clientHeight + 1) break;
      }
    }

    function applyBoxCssSize(){
      const map = {
        small:  'clamp(140px, 30vw, 190px)',
        normal: 'clamp(150px, 34vw, 220px)',
        large:  'clamp(175px, 40vw, 255px)'
      };
      document.documentElement.style.setProperty('--box', map[settings.boxSize] || map.normal);
    }

    // ================= Storage =================
    function saveToStorage(){
      try{
        localStorage.setItem('dms_boxes', JSON.stringify(boxes));
        localStorage.setItem('dms_settings', JSON.stringify(settings));
        localStorage.setItem('dms_header', JSON.stringify({name:nameInput.value, date:dateInput.value, topic:topicInput.value}));
        localStorage.setItem('dms_lang', lang);
      }catch(e){}
    }
    function loadFromStorage(){
      try{
        const sb = localStorage.getItem('dms_boxes');
        const ss = localStorage.getItem('dms_settings');
        const sh = localStorage.getItem('dms_header');
        const sl = localStorage.getItem('dms_lang');

        if (sb) boxes = JSON.parse(sb);
        if (ss) settings = {...settings, ...JSON.parse(ss)};
        if (sh){
          const h = JSON.parse(sh) || {};
          nameInput.value = h.name || '';
          dateInput.value = h.date || '';
          topicInput.value = h.topic || '';
        }
        if (sl) lang = sl;
      }catch(e){
        boxes = [];
      }
    }

    function updateSettingsUI(){
      clampSettings();
      numBoxesInput.value = settings.numBoxes;
      numBoxesValue.textContent = settings.numBoxes;
      columnsSelect.value = String(settings.columns);
      boxSizeSelect.value = settings.boxSize;
      showBackCheckbox.checked = settings.showBack;
      applyBoxCssSize();
    }

    // ================= AUTO (B1) =================
    function autoFillFromB1(index, wordTA, exTA, msgEl, renderBack){
      const wordRaw = (wordTA?.value || "").trim();
      if(!wordRaw){
        if(msgEl) msgEl.textContent = "Type a word first‚Ä¶";
        return;
      }
      const b1 = lookupB1(wordRaw);
      if(!b1){
        if(msgEl) msgEl.textContent = "Not in B1 dictionary (manual ok).";
        // ŸÖŸáŸÖ: ŸÖÿßŸÉŸÜÿÆŸÑŸäÿ¥ autoUsed true
        boxes[index].autoUsed = false;
        saveToStorage();
        if(renderBack) renderBack();
        return;
      }

      boxes[index].autoUsed = true; // ‚úÖ Ÿáÿ∞ÿß ŸáŸà ÿßŸÑŸÖŸÅÿ™ÿßÿ≠

      if(b1.pos && !boxes[index].posOverride){
        boxes[index].posOverride = b1.pos;
      }

      if(b1.de_example){
        exTA.value = b1.de_example;
        boxes[index].example = b1.de_example;
      }

      boxes[index].darijaExampleB1 = b1.darija_example || "";

      autoFitTextarea(wordTA, 11, 18);
      autoFitTextarea(exTA, 11, 14);
      if(renderBack) renderBack();
      saveToStorage();

      if(msgEl) msgEl.textContent = "Auto filled ‚úÖ (you can edit)";
    }

    // ================= Render (screen cards) =================
    function createBoxElement(index){
      const data = boxes[index] || { word:'', example:'', posOverride:'', note:'', darijaExampleB1:'', autoUsed:false };

      const box = document.createElement('div');
      box.className = 'box';

      const flip = document.createElement('div');
      flip.className = 'flip-card' + (settings.showBack ? ' flipped' : '');

      // FRONT
      const front = document.createElement('div');
      front.className = 'flip-side flip-front';

      const wordWrap = document.createElement('div');
      wordWrap.className = 'frontWordWrap';

      const wordTA = document.createElement('textarea');
      wordTA.className = 'wordInput';
      wordTA.placeholder = 'Wort (Deutsch)';
      wordTA.value = data.word || '';
      wordTA.rows = 2;
      wordWrap.appendChild(wordTA);

      const exampleWrap = document.createElement('div');
      exampleWrap.className = 'exampleWrap';

      const exHeader = document.createElement('div');
      exHeader.className = 'exampleHeader';

      const exLabel = document.createElement('div');
      exLabel.className = 'exampleLabel';
      exLabel.textContent = 'Beispiel';

      const autoBtn = document.createElement('button');
      autoBtn.className = 'autoBtn';
      autoBtn.type = 'button';
      autoBtn.textContent = '‚öô Automatik';
      autoBtn.title = 'Generate All Automatically';

      exHeader.appendChild(exLabel);
      exHeader.appendChild(autoBtn);

      const autoMsg = document.createElement('div');
      autoMsg.className = 'autoMsg';
      autoMsg.textContent = '';

      const exTA = document.createElement('textarea');
      exTA.className = 'explainInput';
      exTA.placeholder = 'Bitte hier dein Beispiel schreiben....';
      exTA.value = data.example || '';
      exTA.rows = 5;

      exampleWrap.appendChild(exHeader);
      exampleWrap.appendChild(autoMsg);
      exampleWrap.appendChild(exTA);

      front.appendChild(wordWrap);
      front.appendChild(exampleWrap);

      // BACK
      const back = document.createElement('div');
      back.className = 'flip-side flip-back';

      const posBadge = document.createElement('div');
      posBadge.className = 'posBadge';

      const topRow = document.createElement('div');
      topRow.className = 'backTopRow';

      const arCenter = document.createElement('div');
      arCenter.className = 'arabicCenter';

      const darSide = document.createElement('div');
      darSide.className = 'darijaSide';

      topRow.appendChild(darSide);
      topRow.appendChild(arCenter);

      const noteWrap = document.createElement('div');
      noteWrap.className = 'backNoteWrap';

      const noteLabel = document.createElement('div');
      noteLabel.className = 'noteLabel';
      noteLabel.textContent = 'ÿ¥ÿ±ÿ≠ŸÉ ŸáŸÜÿß / ŸÖŸÑÿßÿ≠ÿ∏ÿ©:';

      const noteTA = document.createElement('textarea');
      noteTA.className = 'noteInput';
      noteTA.placeholder = 'ŸÉÿ™ÿ® ÿ¥ÿ±ÿ≠ŸÉ ŸáŸÜÿß...';
      noteTA.value = data.note || '';
      noteTA.rows = 4;

      const darExampleTA = document.createElement('textarea');
      darExampleTA.className = 'darijaExampleTA';
      darExampleTA.placeholder = 'ŸÖÿ´ÿßŸÑ ÿ®ÿßŸÑÿØÿßÿ±ÿ¨ÿ©‚Ä¶ (ŸÉŸäÿ®ÿßŸÜ ÿ∫Ÿäÿ± ÿ•ŸÑÿß ÿØÿ±ÿ™Ÿä Automatik)';
      darExampleTA.rows = 2;
      darExampleTA.value = data.autoUsed ? ('ŸÖÿ´ÿßŸÑ : ' + (data.darijaExampleB1 || '')) : '';

      noteWrap.appendChild(noteLabel);
      noteWrap.appendChild(noteTA);
      noteWrap.appendChild(darExampleTA);

      back.appendChild(posBadge);
      back.appendChild(topRow);
      back.appendChild(noteWrap);

      function renderBack(){
        const word = wordTA.value;
        const posO = boxes[index].posOverride || '';
        const b1 = lookupB1(word);

        // pos badge
        const posFinal = (posO || (b1 && b1.pos) || guessPOS(word)) || '';
        const posName = (posFinal === 'V') ? 'Verb' : (posFinal === 'N') ? 'Nomen' : (posFinal === 'A') ? 'Adjektiv' : '‚Äî';
        posBadge.textContent = posName + (boxes[index].posOverride ? ' (fix)' : '');

        // ‚úÖ RULE: show Arabic/Darija ONLY if autoUsed
        const autoUsed = !!boxes[index].autoUsed;

        if(autoUsed && b1){
          arCenter.textContent = b1.ar || '';
          darSide.textContent = b1.darija ? ('ÿØÿßÿ±ÿ¨ÿ©: ' + b1.darija) : '';
          const darEx = (boxes[index].darijaExampleB1 || '').trim();
          darExampleTA.value = darEx ? ('ŸÖÿ´ÿßŸÑ : ' + darEx) : '';
        } else {
          arCenter.textContent = '';
          darSide.textContent = '';
          darExampleTA.value = '';
        }
      }

      posBadge.addEventListener('click', () => {
        const cur = boxes[index].posOverride || '';
        const next = (cur === '') ? 'V' : (cur === 'V') ? 'N' : (cur === 'N') ? 'A' : '';
        boxes[index].posOverride = next;
        saveToStorage();
        renderBack();
      });

      autoBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        autoFillFromB1(index, wordTA, exTA, autoMsg, renderBack);
      });

      wordTA.addEventListener('input', () => {
        const prev = boxes[index].word || '';
        boxes[index].word = wordTA.value;

        // ‚úÖ if user changes word after auto, hide auto translations until pressed again
        if(String(prev).trim() !== String(wordTA.value).trim()){
          boxes[index].autoUsed = false;
          boxes[index].darijaExampleB1 = '';
        }

        autoFitTextarea(wordTA, 11, 18);
        renderBack();
        saveToStorage();
      });

      exTA.addEventListener('input', () => {
        boxes[index].example = exTA.value;
        autoFitTextarea(exTA, 11, 14);
        // ŸÖÿßŸÉŸÜÿπÿ±ÿ∂Ÿàÿ¥ ÿØÿßÿ±ÿ¨ÿ© ÿ•ŸÑÿß automatikÿå ŸÑÿ∞ŸÑŸÉ ŸÖÿßŸÉŸäŸÜÿßÿ¥ render ŸáŸÜÿß ÿ∂ÿ±Ÿàÿ±Ÿäÿå ŸàŸÑŸÉŸÜ ŸÜÿÆŸÑŸäŸáÿß
        renderBack();
        saveToStorage();
      });

      noteTA.addEventListener('input', () => {
        boxes[index].note = noteTA.value;
        autoFitTextarea(noteTA, 12, 14);
        saveToStorage();
      });

      // darExampleTA: ŸÜÿÆŸÑŸäŸá read-only ÿπŸÖŸÑŸäÿßŸã (ÿ≠Ÿäÿ™ ŸÉŸäÿ®ÿßŸÜ ÿ∫Ÿäÿ± ŸÅŸÄ Automatik)
      darExampleTA.addEventListener('keydown', (e) => {
        // ŸÖÿßÿ¥Ÿä ÿ∂ÿ±Ÿàÿ±Ÿäÿå ŸàŸÑŸÉŸÜ ÿ®ÿßÿ¥ ŸÖÿßŸäÿ™ÿ®ÿØŸÑÿ¥ ÿ®ÿßŸÑÿ∫ŸÑÿ∑
        e.preventDefault();
      });

      setTimeout(() => {
        autoFitTextarea(wordTA, 11, 18);
        autoFitTextarea(exTA, 11, 14);
        autoFitTextarea(noteTA, 12, 14);
        autoFitTextarea(darExampleTA, 11, 13);
        renderBack();
      }, 0);

      flip.appendChild(front);
      flip.appendChild(back);
      box.appendChild(flip);

      const isTypingTarget = (el) => el && (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT' || el.isContentEditable);
      box.addEventListener('click', (e) => {
        if (isTypingTarget(e.target)) return;
        flip.classList.toggle('flipped');
      });
      box.addEventListener('dblclick', () => flip.classList.toggle('flipped'));

      return box;
    }

    function updateGrid(){
      clearError();
      clampSettings();
      ensureBoxesLength();
      applyBoxCssSize();

      grid.innerHTML = '';
      grid.style.gridTemplateColumns = `repeat(${settings.columns}, var(--box))`;

      for (let i=0; i<settings.numBoxes; i++){
        if (!boxes[i]) boxes[i] = { word:'', example:'', posOverride:'', note:'', darijaExampleB1:'', autoUsed:false };
        grid.appendChild(createBoxElement(i));
      }
      log('Viel Erfolg');
    }

    // ================= Reset =================
    function resetAll(){
      boxes = [];
      settings = { numBoxes: 12, columns: 3, boxSize: 'normal', showBack: false };
      nameInput.value = '';
      dateInput.value = '';
      topicInput.value = '';
      try{
        localStorage.removeItem('dms_boxes');
        localStorage.removeItem('dms_settings');
        localStorage.removeItem('dms_header');
      }catch(_){}
      updateSettingsUI();
      updateGrid();
      log('Viel Erfolg');
    }

    // ================= WhatsApp =================
    const waBtn = document.getElementById('waBtn');
    const waPopup = document.getElementById('waPopup');
    const waClose = document.getElementById('waClose');
    const waInput = document.getElementById('waInput');
    const waSend = document.getElementById('waSend');

    const YOUR_PHONE_NUMBER = "0690010348";
    function normalizeWaNumber(n){
      let s = String(n||"").replace(/\s+/g,'').trim();
      if (/^0\d{9}$/.test(s)) s = '212' + s.slice(1);
      s = s.replace(/^\+/, '');
      return s;
    }
    function openWa(){
      waPopup.classList.add('open');
      setTimeout(() => waInput.focus(), 50);
    }
    function closeWa(){ waPopup.classList.remove('open'); }
    waBtn.addEventListener('click', () => {
      if (waPopup.classList.contains('open')) closeWa();
      else openWa();
    });
    waClose.addEventListener('click', closeWa);
    function sendWa(){
      const msg = (waInput.value || "").trim();
      const text = msg ? msg : "Hallo Said! Ich habe eine Frage zu Deutsch üôÇ";
      const phone = normalizeWaNumber(YOUR_PHONE_NUMBER);
      const url = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;
      window.open(url, "_blank", "noopener,noreferrer");
    }
    waSend.addEventListener('click', sendWa);
    waInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendWa(); });

    // ================= PDF (kept as-is, but back shows Arabic only if autoUsed) =================
    downloadPdfBtn.addEventListener("click", downloadAsPdf);

    function calcPdfLayout(cols, showMeta){
      const pageW = 210, pageH = 297;
      const pad = 10;
      const innerW = pageW - 2*pad;
      const innerH = pageH - 2*pad;

      const gap = 4;
      const safeCols = Math.min(Math.max(1, cols), 4);
      const headerH = showMeta ? 22 : 12;

      const box = (innerW - gap*(safeCols - 1)) / safeCols;
      const rows = Math.max(1, Math.floor((innerH - headerH) / (box + gap)));
      const perPage = safeCols * rows;

      return { safeCols, gap, box, rows, perPage };
    }

    function buildPdfPageDOM(mode, showMeta, startIndex, count, cols, boxMm, gapMm){
      pdfStage.innerHTML = "";

      pdfStage.style.setProperty("--pdfCols", String(cols));
      pdfStage.style.setProperty("--pdfBox", boxMm + "mm");
      pdfStage.style.setProperty("--pdfGap", gapMm + "mm");

      const title = document.createElement("div");
      title.className = "pdfBigTitle";
      title.textContent = "Deutsch mit Said ist einfacher, als du denkst.";
      pdfStage.appendChild(title);

      if (showMeta){
        const meta = document.createElement("div");
        meta.className = "pdfMeta";
        const nm = (nameInput.value || "").trim();
        const dt = (dateInput.value || "").trim();
        const tp = (topicInput.value || "").trim();
        meta.innerHTML = `
          <span>Name: ${nm ? nm : "‚Äî"}</span>
          <span>Datum: ${dt ? dt : "‚Äî"}</span>
          <span>Thema: ${tp ? tp : "‚Äî"}</span>
        `;
        pdfStage.appendChild(meta);
      }

      const g = document.createElement("div");
      g.className = "pdfGrid";

      for (let i=0; i<count; i++){
        const idx = startIndex + i;
        if (idx >= boxes.length) break;

        const d = boxes[idx] || {word:"", example:"", posOverride:"", note:"", darijaExampleB1:"", autoUsed:false};

        const card = document.createElement("div");
        card.className = "pdfCard";

        const inner = document.createElement("div");
        inner.className = "pdfCardInner";

        if (mode === "front"){
          const wWrap = document.createElement("div");
          wWrap.className = "pdfWordWrap";

          const w = document.createElement("div");
          w.className = "pdfWord";
          w.textContent = (d.word || "").trim();
          wWrap.appendChild(w);
          inner.appendChild(wWrap);

          const line = document.createElement("div");
          line.className = "pdfLine";
          inner.appendChild(line);

          const ex = document.createElement("div");
          ex.className = "pdfExample";
          ex.textContent = (d.example || "").trim();
          inner.appendChild(ex);

        } else {
          // ‚úÖ only if autoUsed
          if(d.autoUsed){
            const b1 = lookupB1(d.word);
            const arText = b1 ? (b1.ar || "") : "";
            const darText = b1 ? (b1.darija || "") : "";

            const ar = document.createElement("div");
            ar.className = "pdfAr";
            ar.textContent = (arText || "").trim();
            inner.appendChild(ar);

            const dar = document.createElement("div");
            dar.className = "pdfDar";
            dar.textContent = (darText || "").trim();
            inner.appendChild(dar);

            const darEx = (d.darijaExampleB1 || "").trim();
            if (darEx){
              const line = document.createElement("div");
              line.className = "pdfLine";
              inner.appendChild(line);

              const n = document.createElement("div");
              n.className = "pdfNote";
              n.textContent = "ŸÖÿ´ÿßŸÑ : " + darEx;
              inner.appendChild(n);
            }
          }

          const note = (d.note || "").trim();
          if (note){
            const line2 = document.createElement("div");
            line2.className = "pdfLine";
            inner.appendChild(line2);

            const n2 = document.createElement("div");
            n2.className = "pdfNote";
            n2.textContent = note;
            inner.appendChild(n2);
          }
        }

        card.appendChild(inner);
        g.appendChild(card);
      }

      pdfStage.appendChild(g);
    }

    async function captureStageToCanvas(){
      await new Promise(r => setTimeout(r, 120));
      return await html2canvas(pdfStage, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#ffffff",
        windowWidth: pdfStage.scrollWidth,
        windowHeight: pdfStage.scrollHeight
      });
    }

    async function addA4CanvasAsFullPage(pdf, canvas){
      const img = canvas.toDataURL("image/png");
      pdf.addImage(img, "PNG", 0, 0, 210, 297);
    }

    async function downloadAsPdf(){
      try{
        clearError();
        log("PDF wird erstellt...");

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("p","mm","a4");

        ensureBoxesLength();

        const cols = Math.min(Math.max(1, settings.columns), 4);

        let index = 0;
        let firstPair = true;

        while (index < boxes.length){
          const layoutFront = calcPdfLayout(cols, firstPair);
          const perPage = layoutFront.perPage;

          // FRONT
          buildPdfPageDOM("front", firstPair, index, perPage, layoutFront.safeCols, layoutFront.box, layoutFront.gap);
          const c1 = await captureStageToCanvas();
          await addA4CanvasAsFullPage(pdf, c1);

          // BACK
          pdf.addPage();
          const layoutBack = calcPdfLayout(cols, false);
          buildPdfPageDOM("back", false, index, perPage, layoutBack.safeCols, layoutBack.box, layoutBack.gap);
          const c2 = await captureStageToCanvas();
          await addA4CanvasAsFullPage(pdf, c2);

          index += perPage;
          firstPair = false;

          if (index < boxes.length) pdf.addPage(); // next front
        }

        pdf.save("Deutsch_mit_Said.pdf");
        log("Viel Erfolg");
      }catch(e){
        showError(e.message || String(e));
      }
    }

    // ================= Listeners =================
    function attachListeners(){
      numBoxesInput.addEventListener('input', () => {
        settings.numBoxes = Math.max(1, parseInt(numBoxesInput.value,10) || 12);
        numBoxesValue.textContent = settings.numBoxes;
        updateGrid(); saveToStorage();
      });

      columnsSelect.addEventListener('change', () => {
        settings.columns = parseInt(columnsSelect.value,10);
        updateSettingsUI();
        updateGrid(); saveToStorage();
      });

      boxSizeSelect.addEventListener('change', () => {
        settings.boxSize = boxSizeSelect.value;
        updateSettingsUI();
        updateGrid(); saveToStorage();
      });

      showBackCheckbox.addEventListener('change', () => {
        settings.showBack = showBackCheckbox.checked;
        updateGrid(); saveToStorage();
      });

      resetBtn.addEventListener('click', resetAll);

      langBtn.addEventListener('click', () => {
        lang = (lang === 'de') ? 'en' : 'de';
        applyI18n();
        updateLangButton();
        saveToStorage();
      });

      [nameInput, dateInput, topicInput].forEach(el => el.addEventListener('input', saveToStorage));

      window.addEventListener('resize', () => {
        const before = settings.columns;
        updateSettingsUI();
        if (String(before) !== String(settings.columns)) updateGrid();
      }, {passive:true});
    }

    function init(){
      try{
        loadFromStorage();
        updateSettingsUI();
        ensureBoxesLength();
        applyI18n();
        updateLangButton();
        attachListeners();
        updateGrid();
      }catch(e){
        showError(e.message || String(e));
      }
    }
    window.addEventListener('DOMContentLoaded', init);
  </script>

  <!-- üîΩ Social Footer ‚Äì Deutsch mit Said -->
  <div class="said-social">
    <a href="https://www.instagram.com/saidaiadi?igsh=MWVldzB2OXNvMWwzaQ==" target="_blank" rel="noopener" aria-label="Instagram">
      <svg viewBox="0 0 24 24">
        <path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm10 2H7a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3zm-5 4a6 6 0 1 1 0 12 6 6 0 0 1 0-12zm0 2a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm6.2-.9a1.1 1.1 0 1 1-2.2 0 1.1 1.1 0 0 1 2.2 0z"/>
      </svg>
    </a>

    <a href="https://www.tiktok.com/@saidaiadii?is_from_webapp=1&sender_device=pc" target="_blank" rel="noopener" aria-label="TikTok">
      <svg viewBox="0 0 24 24">
        <path d="M16.5 3c.6 2.6 2.2 4.2 4.8 4.6v3.1c-1.7 0-3.3-.5-4.8-1.4v6.3c0 3.6-2.9 6.4-6.4 6.4S3.7 19.2 3.7 15.6s2.9-6.4 6.4-6.4c.5 0 1 .1 1.5.2v3.4c-.5-.3-1-.4-1.5-.4-1.8 0-3.2 1.4-3.2 3.2S8.3 18.8 10.1 18.8s3.2-1.4 3.2-3.2V3h3.2z"/>
      </svg>
    </a>
  </div>

  <style>
    .said-social{
      display:flex;
      justify-content:center;
      gap:18px;
      padding:40px 0;
    }
    .said-social a{
      width:52px;
      height:52px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:16px;
      background:#0f1412;
      border:1px solid rgba(255,255,255,0.08);
      transition:all 0.3s ease;
      backdrop-filter:blur(6px);
    }
    .said-social a:hover{
      transform:translateY(-4px);
      border-color:#2e5e3a;
      box-shadow:0 0 15px rgba(46,94,58,0.45);
    }
    .said-social svg{
      width:26px;
      height:26px;
      fill:white;
      transition:0.3s ease;
    }
    .said-social a:hover svg{
      fill:#3e7a4b;
    }
  </style>

</body>
</html>
